<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>SMPLJAM</title>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg: #f0f0ec; --panel: #e4e4de; --border: #b8b8b0;
  --accent: #1a1a1a; --red: #cc2200; --dim: #888; --text: #1a1a1a; --sub: #666;
  --green: #006622; --hi: #ffffff;
}
body {
  background: var(--bg); color: var(--text);
  font-family: 'Courier New', Courier, monospace;
  min-height: 100vh; display: flex; flex-direction: column;
  align-items: center; padding: 12px 10px 20px; user-select: none;
}

/* ── Header ── */
header { text-align: center; margin-bottom: 10px; }
h1 { font-family: Impact, 'Arial Black', sans-serif; font-size: 42px; letter-spacing: 6px; color: var(--text); line-height: 1; }
.tagline { font-size: 9px; color: var(--dim); letter-spacing: 3px; text-transform: uppercase; margin-top: 2px; }

/* ── Transport ── */
.transport {
  display: flex; align-items: center; gap: 10px;
  background: var(--panel); border: 1px solid var(--border);
  padding: 8px 12px; border-radius: 4px;
  width: 100%; max-width: 540px; margin-bottom: 10px;
  flex-wrap: wrap; justify-content: center;
}
.bpm-group { display: flex; align-items: center; gap: 6px; }
.bpm-label { font-size: 9px; color: var(--dim); letter-spacing: 2px; }
.bpm-display { font-family: Impact, 'Arial Black', sans-serif; font-size: 28px; color: var(--text); width: 56px; text-align: center; }
.bpm-controls { display: flex; flex-direction: column; gap: 2px; }
.bpm-btn {
  background: var(--hi); border: 1px solid var(--border); color: var(--text);
  font-size: 9px; padding: 1px 6px; cursor: pointer; transition: all 0.1s; border-radius: 2px;
}
.bpm-btn:hover { background: var(--accent); color: var(--hi); }
.divider { width: 1px; height: 32px; background: var(--border); flex-shrink: 0; }
#play-btn {
  background: var(--accent); border: 2px solid var(--accent); color: var(--hi);
  font-family: Impact, 'Arial Black', sans-serif; font-size: 15px; letter-spacing: 2px;
  padding: 6px 14px; cursor: pointer; transition: all 0.15s; border-radius: 3px;
}
#play-btn.playing { background: var(--red); border-color: var(--red); }
#metro-btn {
  background: var(--hi); border: 1px solid var(--border); color: var(--sub);
  font-family: 'Courier New', Courier, monospace; font-size: 9px; letter-spacing: 1px;
  padding: 5px 8px; cursor: pointer; transition: all 0.15s; border-radius: 2px;
}
#metro-btn.on { background: var(--accent); color: var(--hi); border-color: var(--accent); }
#metro-btn:hover { border-color: var(--accent); }
.beat-dots { display: flex; gap: 5px; align-items: center; }
.beat-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--border); transition: background 0.05s; }
.beat-dot.active { background: var(--accent); }
.groove-inline {
  background: var(--hi); border: 1px solid var(--border); color: var(--text);
  font-family: 'Courier New', Courier, monospace; font-size: 9px; padding: 5px 6px;
  border-radius: 2px; cursor: pointer; max-width: 130px;
}
.groove-inline:focus { outline: none; border-color: var(--accent); }

/* ── Pads Grid ── */
.pads-grid {
  display: grid; grid-template-columns: 1fr 1fr; gap: 8px;
  width: 100%; max-width: 540px;
}
.pad {
  background: var(--hi); border: 2px solid var(--border); border-radius: 5px;
  padding: 10px; display: flex; flex-direction: column; gap: 7px;
  position: relative; overflow: hidden; transition: border-color 0.15s;
}
.pad::before {
  content: ''; position: absolute; inset: 0; background: var(--accent);
  opacity: 0; transition: opacity 0.08s; pointer-events: none;
}
.pad.flashing::before { opacity: 0.07; }
.pad.flash-strong::before { opacity: 0.15; }
.pad.has-sample { border-color: var(--dim); }
.pad.recording { border-color: var(--red) !important; animation: pulse 0.5s infinite alternate; }
.pad.is-bass { border-color: var(--green) !important; border-style: dashed; }
.pad.is-bass.has-bass { border-style: solid; }
@keyframes pulse {
  from { box-shadow: 0 0 0 0 rgba(204,34,0,0); }
  to   { box-shadow: 0 0 8px 2px rgba(204,34,0,0.3); }
}

.pad-header { display: flex; justify-content: space-between; align-items: center; }
.pad-label { font-family: Impact, 'Arial Black', sans-serif; font-size: 18px; letter-spacing: 1px; color: var(--dim); }
.pad.has-sample .pad-label, .pad.is-bass .pad-label { color: var(--text); }
.pad-status { font-size: 8px; letter-spacing: 1px; color: var(--dim); text-transform: uppercase; }
.pad.recording .pad-status { color: var(--red); font-weight: bold; }
.pad.has-sample .pad-status { color: var(--green); }

.waveform-canvas { width: 100%; height: 32px; display: block; border-radius: 2px; background: var(--panel); }

/* Bass pitch display inside pad 4 */
.bass-pitch { font-family: Impact, 'Arial Black', sans-serif; font-size: 22px; color: var(--green); height: 32px; display: flex; align-items: center; justify-content: center; background: var(--panel); border-radius: 2px; letter-spacing: 2px; }

/* Groove row selector */
.pad-row-select { display: flex; align-items: center; gap: 5px; }
.row-select-label { font-size: 8px; color: var(--dim); letter-spacing: 1px; white-space: nowrap; }
.row-select {
  flex: 1; background: var(--panel); border: 1px solid var(--border); color: var(--dim);
  font-family: 'Courier New', Courier, monospace; font-size: 8px; padding: 3px 4px;
  border-radius: 2px; cursor: pointer;
}
.row-select:focus { outline: none; border-color: var(--accent); }
.pad.has-sample .row-select { color: var(--text); }

/* OFS indicator */
.ofs-display { font-size: 8px; color: var(--dim); letter-spacing: 1px; white-space: nowrap; }
.ofs-display.active { color: var(--red); }

/* Action buttons row */
.pad-actions { display: flex; gap: 4px; }
.pad-btn {
  flex: 1; font-family: 'Courier New', Courier, monospace; font-size: 9px; letter-spacing: 0px;
  padding: 6px 2px; border-radius: 2px; cursor: pointer; border: 1px solid;
  transition: all 0.1s; text-transform: uppercase; background: var(--hi);
}
.btn-rec  { border-color: var(--red); color: var(--red); }
.btn-rec:hover, .btn-rec.active { background: var(--red); color: var(--hi); }
.btn-play-pad { border-color: var(--border); color: var(--dim); }
.btn-play-pad:hover { background: var(--accent); color: var(--hi); border-color: var(--accent); }
.btn-play-pad:disabled { opacity: 0.3; cursor: default; }
.btn-clear { border-color: var(--border); color: var(--dim); }
.btn-clear:hover { background: var(--accent); color: var(--hi); }
.btn-clear:disabled { opacity: 0.3; cursor: default; }
.btn-ofs { border-color: var(--border); color: var(--dim); }
.btn-ofs:hover { background: var(--red); color: var(--hi); border-color: var(--red); }
.btn-ofs.has-offset { border-color: var(--red); color: var(--red); }
.btn-cut { border-color: var(--border); color: var(--dim); }
.btn-cut:hover { background: var(--accent); color: var(--hi); }
.btn-cut.active { background: var(--accent); color: var(--hi); border-color: var(--accent); }
.btn-cut:disabled { opacity: 0.3; cursor: default; }

/* Bass sing button */
.btn-sing { border-color: var(--green); color: var(--green); }
.btn-sing:hover, .btn-sing.active { background: var(--green); color: var(--hi); border-color: var(--green); }

/* ── Groove guide (collapsible) ── */
.groove-panel {
  width: 100%; max-width: 540px; margin-top: 8px;
  background: var(--panel); border: 1px solid var(--border); border-radius: 4px; overflow: hidden;
}
.groove-header { display: flex; align-items: center; justify-content: space-between; padding: 8px 12px; cursor: pointer; }
.groove-panel.open .groove-header { border-bottom: 1px solid var(--border); }
.groove-header-title { font-family: Impact, 'Arial Black', sans-serif; font-size: 13px; letter-spacing: 2px; color: var(--dim); }
.groove-chevron { font-size: 9px; color: var(--dim); transition: transform 0.2s; }
.groove-panel.open .groove-chevron { transform: rotate(180deg); }
.groove-body { display: none; padding: 10px 12px; }
.groove-panel.open .groove-body { display: block; }
.groove-desc { font-size: 8px; color: var(--dim); letter-spacing: 1px; margin-bottom: 8px; line-height: 1.5; }
.groove-beat-labels { display: flex; margin-left: 38px; margin-bottom: 2px; }
.groove-beat-label { flex: 1; font-size: 7px; color: var(--dim); text-align: center; }
.groove-grid { display: flex; flex-direction: column; gap: 4px; }
.groove-row-el { display: flex; align-items: center; gap: 5px; }
.groove-row-label { font-size: 8px; color: var(--dim); width: 32px; text-transform: uppercase; flex-shrink: 0; }
.groove-steps { display: flex; gap: 2px; flex: 1; }
.groove-step { flex: 1; height: 14px; border-radius: 1px; background: var(--border); transition: background 0.08s; }
.groove-step.beat-gap { margin-left: 3px; }
.groove-step.on    { background: var(--accent); opacity: 0.35; }
.groove-step.accent { background: var(--accent); opacity: 0.85; }
.groove-step.now   { outline: 2px solid var(--red); }
.groove-legend { display: flex; gap: 12px; margin-top: 8px; }
.legend-item { display: flex; align-items: center; gap: 4px; font-size: 8px; color: var(--dim); }
.legend-swatch { width: 10px; height: 10px; border-radius: 1px; }

/* ── Status bar ── */
.status-bar { margin-top: 8px; font-size: 9px; color: var(--dim); letter-spacing: 1px; text-align: center; min-height: 14px; width: 100%; max-width: 540px; }
</style>
</head>
<body>

<header>
  <h1>SMPLJAM</h1>
  <div class="tagline">groove sampler</div>
</header>

<div class="transport">
  <div class="bpm-group">
    <span class="bpm-label">BPM</span>
    <div class="bpm-display" id="bpm-display">120</div>
    <div class="bpm-controls">
      <button class="bpm-btn" id="bpm-up">&#9650;</button>
      <button class="bpm-btn" id="bpm-down">&#9660;</button>
    </div>
  </div>
  <div class="divider"></div>
  <button id="play-btn">&#9654; PLAY</button>
  <div class="divider"></div>
  <button id="metro-btn">CLICK</button>
  <div class="divider"></div>
  <select class="groove-inline" id="groove-select"></select>
  <div class="divider"></div>
  <div class="beat-dots">
    <div class="beat-dot" id="dot-0"></div>
    <div class="beat-dot" id="dot-1"></div>
    <div class="beat-dot" id="dot-2"></div>
    <div class="beat-dot" id="dot-3"></div>
  </div>
</div>

<div class="pads-grid" id="pads-grid"></div>

<div class="groove-panel" id="groove-panel">
  <div class="groove-header" id="groove-header">
    <span class="groove-header-title">GROOVE GUIDE</span>
    <span class="groove-chevron">&#9660;</span>
  </div>
  <div class="groove-body">
    <div class="groove-desc" id="groove-desc"></div>
    <div class="groove-beat-labels" id="groove-beat-labels"></div>
    <div class="groove-grid" id="groove-grid"></div>
    <div class="groove-legend">
      <div class="legend-item"><div class="legend-swatch" style="background:var(--accent);opacity:0.85"></div>accent</div>
      <div class="legend-item"><div class="legend-swatch" style="background:var(--accent);opacity:0.35"></div>hit</div>
      <div class="legend-item"><div class="legend-swatch" style="background:var(--border)"></div>silent</div>
    </div>
  </div>
</div>

<div class="status-bar" id="status-bar">tap anywhere to enable mic</div>

<script>
// ═══════════════════════════════════════════════════════
// CONFIG
// ═══════════════════════════════════════════════════════
var NUM_PADS   = 4;
var PAD_NAMES  = ['PAD 1','PAD 2','PAD 3','BASS'];
var PAD_KEYS   = ['Q','W','A','S'];
var PAD_ROW_DEFAULTS = ['kick','snare','hihat','kick'];
var VELOCITY   = [0, 0.42, 1.0];

var bpm = 120;
var isPlaying = false;
var currentStep = -1;
var beatInterval = null;
var audioCtx = null;
var micStream = null;
var activeRecordingPad = null;
var metroOn = true;
var metroScheduler = null;
var metroNextTime = 0;
var metroBeat = 0;
var metroGain = null;

// VAD constants
var VAD_POLL_MS      = 20;
var VAD_CALIBRATE_MS = 300;
var VAD_TAIL_MS      = 120;
var VAD_MAX_MS       = 8000;

var pads = [];
for (var pi = 0; pi < NUM_PADS; pi++) {
  pads.push({
    index:      pi,
    isBass:     pi === 3,
    buffer:     null,
    bassNotes:  null,      // only pad 3: array of 16 note objects or null
    isRecording: false,
    pcmChunks:  [],
    scriptRecorder: null,
    muteGain:   null,
    analyser:   null,
    analyserSource: null,
    liveAnimFrame: null,
    vadInterval:   null,
    grooveRow:  PAD_ROW_DEFAULTS[pi],
    offset:     0,         // OFS: step offset 0-15
    cut:        false,     // CUT: play only first 50%
  });
}

// ═══════════════════════════════════════════════════════
// GROOVE DATA
// ═══════════════════════════════════════════════════════
var GROOVES = [
  { name:"Basic Rock",
    desc:"Kick on 1&3, snare on 2&4, 8th hi-hats.",
    kick: [2,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0],
    snare:[0,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0],
    hihat:[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0] },
  { name:"Funk",
    desc:"Heavy on beat 1. Kick/snare syncopate. Hi-hats open/closed.",
    kick: [2,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0],
    snare:[0,0,0,0,2,0,0,1,0,0,0,0,2,0,1,0],
    hihat:[2,1,1,1,1,2,1,1,2,1,1,1,1,2,1,1] },
  { name:"Hip-Hop",
    desc:"Laid-back kick, snare on 2&4, sparse hi-hats.",
    kick: [2,0,0,0,0,0,1,0,2,0,0,0,0,1,0,0],
    snare:[0,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0],
    hihat:[1,0,1,0,0,1,0,0,1,0,1,0,0,1,0,1] },
  { name:"Trap",
    desc:"Booming kick on 1, snare on 3, rolling 16th hi-hats.",
    kick: [2,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0],
    snare:[0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0],
    hihat:[1,1,2,1,1,1,2,1,1,1,2,1,1,1,2,1] },
  { name:"Four-on-Floor",
    desc:"Kick every beat, snare on 2&4, 16th hi-hats.",
    kick: [2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0],
    snare:[0,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0],
    hihat:[1,1,2,1,1,1,2,1,1,1,2,1,1,1,2,1] },
  { name:"Disco",
    desc:"Four-on-floor kick, hi-hat on the 'and' of every beat.",
    kick: [2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0],
    snare:[0,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0],
    hihat:[1,0,2,0,1,0,2,0,1,0,2,0,1,0,2,0] },
  { name:"Shuffle",
    desc:"Triplet swing. Accent on the 'and' of each beat.",
    kick: [2,0,1,0,0,1,0,0,2,0,1,0,0,1,0,0],
    snare:[0,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0],
    hihat:[1,0,2,0,1,0,2,0,1,0,2,0,1,0,2,0] },
  { name:"Jazz Swing",
    desc:"Ride carries swing triplet. Kick sparse. Snare soft on 2&4.",
    kick: [2,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],
    snare:[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],
    hihat:[2,0,1,0,2,0,1,0,2,0,1,0,2,0,1,0] },
  { name:"Reggae",
    desc:"Soft kick on 1, snare on beat 3, offbeat hi-hat 'skank'.",
    kick: [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
    snare:[0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0],
    hihat:[0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0] },
  { name:"Bossa Nova",
    desc:"3+3+2 clave feel. Snare subtle. Hi-hat flows smoothly.",
    kick: [2,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0],
    snare:[0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0],
    hihat:[1,1,0,1,1,0,1,1,0,1,1,0,1,1,0,1] },
  { name:"Breakbeat",
    desc:"Snare on unexpected 16ths. Kick syncopates heavily.",
    kick: [2,0,0,0,0,0,1,0,0,0,2,0,0,1,0,0],
    snare:[0,0,0,0,2,0,0,1,0,0,0,0,1,1,0,0],
    hihat:[2,1,1,1,1,1,1,1,2,1,1,1,1,1,1,1] },
  { name:"Trip-Hop",
    desc:"Slow, heavy. Kick on 1 + 'and' of 2. Sparse hi-hats.",
    kick: [2,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0],
    snare:[0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0],
    hihat:[1,0,0,0,1,0,0,0,1,0,0,0,0,0,1,0] },
  { name:"2-Step",
    desc:"Kick avoids 2&4. Clap on 'and' of 2 and 4.",
    kick: [2,0,0,0,0,1,0,0,2,0,0,1,0,0,0,0],
    snare:[0,0,0,0,0,0,2,0,0,0,0,0,0,0,2,0],
    hihat:[1,0,1,1,0,1,0,1,1,0,1,1,0,1,0,1] },
  { name:"Afrobeat",
    desc:"Clave hi-hat. Kick and snare polyrhythmic cycle.",
    kick: [2,0,0,1,0,0,1,0,0,0,2,0,0,1,0,0],
    snare:[0,0,0,0,1,0,0,0,1,0,0,0,0,0,1,0],
    hihat:[2,0,1,0,1,0,2,0,1,0,1,0,2,0,1,0] },
  { name:"Samba",
    desc:"Lively syncopated kick, ghost snares, 16th hi-hats.",
    kick: [2,0,1,0,0,1,0,1,2,0,1,0,0,1,0,0],
    snare:[0,1,0,0,2,0,1,0,0,1,0,0,2,0,1,0],
    hihat:[2,1,1,1,2,1,1,1,2,1,1,1,2,1,1,1] }
];

function getGrooveRow(groove, row) {
  if (row !== 'perc') return groove[row];
  var h = groove['hihat'];
  var s = new Array(16);
  for (var i = 0; i < 16; i++) s[i] = h[(i + 14) % 16];
  return s;
}

// ═══════════════════════════════════════════════════════
// AUDIO CONTEXT
// ═══════════════════════════════════════════════════════
function getAudioCtx() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    metroGain = audioCtx.createGain();
    metroGain.gain.value = metroOn ? 1 : 0;
    metroGain.connect(audioCtx.destination);
  }
  if (audioCtx.state === 'suspended') audioCtx.resume();
  return audioCtx;
}

async function getMic() {
  if (micStream) return micStream;
  try {
    micStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
    return micStream;
  } catch(e) { setStatus('mic access denied'); return null; }
}

// ═══════════════════════════════════════════════════════
// METRONOME
// ═══════════════════════════════════════════════════════
function scheduleClick(time, accent) {
  var ctx = getAudioCtx();
  var osc = ctx.createOscillator();
  var env = ctx.createGain();
  osc.connect(env); env.connect(metroGain);
  osc.frequency.value = accent ? 1200 : 900;
  osc.type = 'sine';
  env.gain.setValueAtTime(0, time);
  env.gain.linearRampToValueAtTime(0.6, time + 0.003);
  env.gain.exponentialRampToValueAtTime(0.001, time + 0.06);
  osc.start(time); osc.stop(time + 0.08);
}
function startMetronome() {
  var ctx = getAudioCtx();
  metroBeat = 0; metroNextTime = ctx.currentTime + 0.05;
  function sched() {
    while (metroNextTime < ctx.currentTime + 0.2) {
      scheduleClick(metroNextTime, metroBeat % 4 === 0);
      metroBeat++; metroNextTime += 60.0 / bpm;
    }
  }
  metroScheduler = setInterval(sched, 50); sched();
}
function stopMetronome()    { if (metroScheduler) { clearInterval(metroScheduler); metroScheduler = null; } }
function restartMetronome() { stopMetronome(); startMetronome(); }

document.getElementById('metro-btn').addEventListener('click', function() {
  metroOn = !metroOn;
  var btn = document.getElementById('metro-btn');
  btn.classList.toggle('on', metroOn);
  btn.textContent = metroOn ? 'CLICK' : 'CLICK';
  if (metroGain) metroGain.gain.setTargetAtTime(metroOn ? 1 : 0, getAudioCtx().currentTime, 0.02);
});

// ═══════════════════════════════════════════════════════
// LIVE VISUALISER
// ═══════════════════════════════════════════════════════
function startLiveViz(padIdx) {
  var pad = pads[padIdx];
  var canvas = document.getElementById('wave-' + padIdx);
  var ctx2 = canvas.getContext('2d');
  var analyser = pad.analyser;
  var bufLen = analyser.frequencyBinCount;
  var dataArr = new Uint8Array(bufLen);
  var W = canvas.width, H = canvas.height;
  var history = new Float32Array(W); var histPos = 0;
  function draw() {
    if (!pad.isRecording) return;
    pad.liveAnimFrame = requestAnimationFrame(draw);
    analyser.getByteTimeDomainData(dataArr);
    var sum = 0;
    for (var k = 0; k < bufLen; k++) { var v = (dataArr[k]/128.0)-1.0; sum += v*v; }
    var rms = Math.sqrt(sum/bufLen);
    history[histPos % W] = rms; histPos++;
    ctx2.clearRect(0,0,W,H);
    var mid = H/2;
    for (var x = 0; x < W; x++) {
      var hi = history[(histPos-W+x+W*4) % W];
      var amp = Math.min(hi * H * 3.5, mid);
      var a = 0.3 + (x/W)*0.7;
      ctx2.fillStyle = 'rgba(204,34,0,' + a + ')';
      ctx2.fillRect(x, mid-amp, 1, Math.max(amp*2, 1));
    }
  }
  draw();
}
function stopLiveViz(padIdx) {
  var pad = pads[padIdx];
  if (pad.liveAnimFrame) { cancelAnimationFrame(pad.liveAnimFrame); pad.liveAnimFrame = null; }
  if (pad.analyserSource) { try { pad.analyserSource.disconnect(); } catch(e) {} pad.analyserSource = null; }
  pad.analyser = null;
}

// ═══════════════════════════════════════════════════════
// RECORDING (ScriptProcessor — works on iOS Safari)
// ═══════════════════════════════════════════════════════
async function toggleRecord(i) {
  if (pads[i].isRecording) { stopRecord(i); return; }
  if (activeRecordingPad !== null) stopRecord(activeRecordingPad);
  await startRecord(i);
}

async function startRecord(i) {
  var pad = pads[i];
  pad.isRecording = true; updatePadUI(i);
  setStatus('getting mic...');
  getAudioCtx();
  if (!metroScheduler) startMetronome();
  var stream = await getMic();
  if (!stream) { pad.isRecording = false; updatePadUI(i); return; }
  pad.pcmChunks = []; activeRecordingPad = i;

  var ctx = getAudioCtx();
  var source = ctx.createMediaStreamSource(stream);
  var analyser = ctx.createAnalyser(); analyser.fftSize = 1024;
  source.connect(analyser);
  pad.analyser = analyser; pad.analyserSource = source;
  startLiveViz(i);

  var recorder = ctx.createScriptProcessor(4096, 1, 1);
  recorder.onaudioprocess = function(e) {
    if (!pad.isRecording) return;
    pad.pcmChunks.push(new Float32Array(e.inputBuffer.getChannelData(0)));
  };
  var muteGain = ctx.createGain(); muteGain.gain.value = 0;
  source.connect(recorder); recorder.connect(muteGain); muteGain.connect(ctx.destination);
  pad.scriptRecorder = recorder; pad.muteGain = muteGain;

  updatePadUI(i); setStatus('calibrating... (pad ' + (i+1) + ')');

  // VAD
  var pollCount = 0;
  var calNeeded = Math.round(VAD_CALIBRATE_MS / VAD_POLL_MS);
  var tailNeeded = Math.round(VAD_TAIL_MS / VAD_POLL_MS);
  var maxNeeded  = Math.round(VAD_MAX_MS / VAD_POLL_MS);
  var floorAccum = 0, floorN = 0, threshold = 0.015, tailCount = 0;
  var phase = 'calibrate';
  pad.vadInterval = setInterval(function() {
    if (!pad.isRecording || !pad.analyser) { stopVAD(i); return; }
    pollCount++;
    var bl = pad.analyser.frequencyBinCount;
    var d = new Uint8Array(bl); pad.analyser.getByteTimeDomainData(d);
    var s2 = 0; for (var k=0;k<bl;k++){var v=(d[k]/128.0)-1.0;s2+=v*v;}
    var rms = Math.sqrt(s2/bl);
    if (phase==='calibrate') {
      floorAccum+=rms; floorN++;
      if (pollCount>=calNeeded) { threshold=Math.max((floorAccum/floorN)*8,0.012); phase='waiting'; setStatus('ready — make your sound'); }
    } else if (phase==='waiting') {
      if (rms>threshold) { phase='active'; tailCount=0; setStatus('capturing...'); }
    } else {
      if (rms<threshold) { tailCount++; if (tailCount>=tailNeeded) { stopVAD(i); if(pad.isRecording) stopRecord(i); return; } }
      else tailCount=0;
    }
    if (pollCount>=maxNeeded) { stopVAD(i); if(pad.isRecording) stopRecord(i); }
  }, VAD_POLL_MS);
}

function stopVAD(i) {
  if (pads[i].vadInterval) { clearInterval(pads[i].vadInterval); pads[i].vadInterval = null; }
}

function stopRecord(i) {
  var pad = pads[i];
  if (!pad.isRecording) return;
  stopVAD(i); pad.isRecording = false; activeRecordingPad = null; stopLiveViz(i);
  if (pad.scriptRecorder) { try { pad.scriptRecorder.disconnect(); } catch(e) {} pad.scriptRecorder = null; }
  if (pad.muteGain) { try { pad.muteGain.disconnect(); } catch(e) {} pad.muteGain = null; }
  setStatus('processing...'); updatePadUI(i);
  finalizeRecording(i);
}

// ═══════════════════════════════════════════════════════
// TRIM
// ═══════════════════════════════════════════════════════
function trimSilence(buffer) {
  var data = buffer.getChannelData(0);
  var sr = buffer.sampleRate;
  var peak = 0;
  for (var p = 0; p < data.length; p++) { var ap = Math.abs(data[p]); if (ap > peak) peak = ap; }
  if (peak < 0.001) return buffer;
  var threshold = peak * 0.05;
  var winSize = Math.max(Math.floor(sr * 0.002), 1);
  var startSample = -1;
  for (var n = 0; n < data.length - winSize; n += winSize) {
    var ws = 0;
    for (var w = 0; w < winSize; w++) ws += data[n+w]*data[n+w];
    if (Math.sqrt(ws/winSize) > threshold) { startSample = Math.max(0, n - winSize); break; }
  }
  if (startSample <= 0) return buffer;
  var ctx = getAudioCtx(); var nc = buffer.numberOfChannels;
  var newLen = buffer.length - startSample;
  if (newLen <= 0) return buffer;
  var out = ctx.createBuffer(nc, newLen, sr);
  for (var c = 0; c < nc; c++) {
    var src = buffer.getChannelData(c), dst = out.getChannelData(c);
    for (var s = 0; s < newLen; s++) dst[s] = src[startSample+s];
  }
  return out;
}

function finalizeRecording(i) {
  var pad = pads[i];
  var chunks = pad.pcmChunks;
  if (!chunks || chunks.length === 0) { setStatus('no audio — try again'); updatePadUI(i); return; }
  var totalLen = 0;
  for (var ci = 0; ci < chunks.length; ci++) totalLen += chunks[ci].length;
  var combined = new Float32Array(totalLen); var offset = 0;
  for (var ci2 = 0; ci2 < chunks.length; ci2++) { combined.set(chunks[ci2], offset); offset += chunks[ci2].length; }
  var ctx = getAudioCtx(); var sr = ctx.sampleRate;
  var decoded = ctx.createBuffer(1, combined.length, sr);
  decoded.getChannelData(0).set(combined);
  pad.pcmChunks = [];
  pad.buffer = trimSilence(decoded);
  drawWaveform(i); updatePadUI(i);
  setStatus('pad ' + (i+1) + ' ready (' + pad.buffer.duration.toFixed(3) + 's)');
}

// ═══════════════════════════════════════════════════════
// PLAYBACK
// ═══════════════════════════════════════════════════════
function triggerPad(i, velocity) {
  var pad = pads[i];
  if (!pad.buffer || velocity <= 0) return;
  var ctx = getAudioCtx();
  var src = ctx.createBufferSource();
  src.buffer = pad.buffer;
  var gain = ctx.createGain();
  gain.gain.value = Math.min(velocity, 1.0);
  src.connect(gain); gain.connect(ctx.destination);

  if (pad.cut) {
    // Play first 50% then fade out
    var halfDur = pad.buffer.duration * 0.5;
    var fadeStart = halfDur * 0.85;
    var fadeDur   = halfDur * 0.15;
    gain.gain.setValueAtTime(velocity, ctx.currentTime + fadeStart);
    gain.gain.linearRampToValueAtTime(0.0001, ctx.currentTime + halfDur);
    src.start(); src.stop(ctx.currentTime + halfDur);
  } else {
    src.start();
  }

  var el = document.getElementById('pad-' + i);
  el.classList.add('flashing');
  if (velocity > 0.7) el.classList.add('flash-strong');
  setTimeout(function() { el.classList.remove('flashing','flash-strong'); }, velocity > 0.7 ? 100 : 50);
}

function clearPad(i) {
  stopVAD(i);
  pads[i].buffer = null;
  pads[i].bassNotes = null;
  pads[i].offset = 0;
  pads[i].cut = false;
  clearWaveform(i); updatePadUI(i);
  setStatus('pad ' + (i+1) + ' cleared');
}

// ═══════════════════════════════════════════════════════
// BASS SYNTH + PITCH DETECTION (Pad 4)
// ═══════════════════════════════════════════════════════
var NOTE_NAMES = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
var ALL_NOTES = [];  // all notes across bass range
for (var oct = 1; oct <= 4; oct++) {
  for (var ni = 0; ni < 12; ni++) {
    var midi = (oct+1)*12 + ni;
    ALL_NOTES.push({ midi: midi, freq: 440 * Math.pow(2,(midi-69)/12), name: NOTE_NAMES[ni]+oct });
  }
}

function detectPitch(buffer, sampleRate) {
  var SIZE = buffer.length;
  var MAX_SAMPLES = Math.floor(SIZE / 2);
  var rms = 0;
  for (var i = 0; i < SIZE; i++) rms += buffer[i]*buffer[i];
  rms = Math.sqrt(rms/SIZE);
  if (rms < 0.008) return null;
  var best_offset = -1, best_corr = 0;
  for (var offset = 20; offset < MAX_SAMPLES; offset++) {
    var c = 0;
    for (var j = 0; j < MAX_SAMPLES; j++) c += buffer[j] * buffer[j+offset];
    if (c > best_corr) { best_corr = c; best_offset = offset; }
  }
  if (best_offset === -1 || best_corr < 0.01) return null;
  return sampleRate / best_offset;
}

function freqToNote(freq) {
  if (!freq || freq < 40) return null;
  var midi = 12 * Math.log2(freq / 440) + 69;
  var best = null, bestDist = 999;
  ALL_NOTES.forEach(function(n) {
    var d = Math.abs(n.midi - midi);
    if (d < bestDist) { bestDist = d; best = n; }
  });
  return bestDist < 2.5 ? best : null;
}

function playBassNote(freq, duration, vel) {
  if (!freq) return;
  var ctx = getAudioCtx(); var now = ctx.currentTime;
  var osc1 = ctx.createOscillator();
  var osc2 = ctx.createOscillator();
  var gain = ctx.createGain();
  var filt = ctx.createBiquadFilter();
  osc1.type = 'sawtooth'; osc1.frequency.value = freq;
  osc2.type = 'sine'; osc2.frequency.value = freq;
  filt.type = 'lowpass';
  filt.frequency.setValueAtTime(300, now);
  filt.frequency.linearRampToValueAtTime(1400, now + 0.03);
  filt.frequency.exponentialRampToValueAtTime(450, now + duration * 0.6);
  filt.Q.value = 2;
  gain.gain.setValueAtTime(0, now);
  gain.gain.linearRampToValueAtTime(vel * 0.65, now + 0.018);
  gain.gain.setValueAtTime(vel * 0.65, now + duration * 0.55);
  gain.gain.exponentialRampToValueAtTime(0.001, now + duration * 0.92);
  osc1.connect(filt); osc2.connect(filt); filt.connect(gain); gain.connect(ctx.destination);
  osc1.start(now); osc1.stop(now+duration);
  osc2.start(now); osc2.stop(now+duration);
}

// Bass recording state
var bassCapturing = false;
var bassAnalyser2 = null;
var bassAnalyserSource2 = null;
var bassPitchInterval = null;
var bassRecordedNotes = [];

async function toggleBassRecord() {
  if (bassCapturing) { stopBassCapture(); return; }
  bassCapturing = true;
  bassRecordedNotes = [];
  var btn = document.getElementById('btn-sing-3');
  btn.classList.add('active'); btn.textContent = 'STOP';
  document.getElementById('pad-status-3').textContent = 'sing...';
  getAudioCtx();
  var stream = await getMic();
  if (!stream) { stopBassCapture(); return; }
  var ctx = getAudioCtx();
  var source = ctx.createMediaStreamSource(stream);
  var analyser = ctx.createAnalyser(); analyser.fftSize = 2048;
  source.connect(analyser);
  bassAnalyser2 = analyser; bassAnalyserSource2 = source;
  var buf = new Float32Array(analyser.fftSize);
  var lastNote = null, steadyCount = 0, STEADY = 3;
  bassPitchInterval = setInterval(function() {
    if (!bassCapturing) return;
    analyser.getFloatTimeDomainData(buf);
    var freq = detectPitch(buf, ctx.sampleRate);
    var note = freq ? freqToNote(freq) : null;
    // Show live note in waveform area (repurposed as pitch display)
    var pitchEl = document.getElementById('bass-pitch-3');
    if (pitchEl) pitchEl.textContent = note ? note.name : (freq ? '~'+Math.round(freq)+'hz' : '—');
    if (note && lastNote && note.midi === lastNote.midi) {
      steadyCount++;
      if (steadyCount === STEADY) {
        bassRecordedNotes.push(note);
        setStatus('heard: ' + bassRecordedNotes.map(function(n){return n.name;}).join(' '));
      }
    } else { steadyCount = 0; }
    lastNote = note;
  }, 80);
}

function stopBassCapture() {
  bassCapturing = false;
  clearInterval(bassPitchInterval); bassPitchInterval = null;
  if (bassAnalyserSource2) { try { bassAnalyserSource2.disconnect(); } catch(e) {} bassAnalyserSource2 = null; }
  bassAnalyser2 = null;
  var btn = document.getElementById('btn-sing-3');
  if (btn) { btn.classList.remove('active'); btn.textContent = 'SING'; }
  var pitchEl = document.getElementById('bass-pitch-3');
  if (pitchEl) pitchEl.textContent = '';

  if (bassRecordedNotes.length === 0) { setStatus('no notes heard — try again'); return; }

  // Spread across 16 steps
  var notes = new Array(16).fill(null);
  var toPlace = bassRecordedNotes.slice(0, 16);
  var spacing = Math.floor(16 / toPlace.length);
  toPlace.forEach(function(n, idx) { notes[Math.min(idx*spacing, 15)] = n; });

  pads[3].bassNotes = notes;
  pads[3].buffer = true; // signal that pad has content
  updatePadUI(3);
  setStatus(toPlace.length + ' notes captured — hit PLAY');
  drawBassSteps();
}

function drawBassSteps() {
  var canvas = document.getElementById('wave-3');
  var ctx2 = canvas.getContext('2d');
  var W = canvas.width, H = canvas.height;
  ctx2.clearRect(0,0,W,H);
  ctx2.fillStyle = '#e4e4de';
  ctx2.fillRect(0,0,W,H);
  var notes = pads[3].bassNotes;
  if (!notes) return;
  var sw = W / 16;
  for (var s = 0; s < 16; s++) {
    var n = notes[s];
    if (n) {
      ctx2.fillStyle = '#006622';
      ctx2.fillRect(s*sw+1, 2, sw-2, H-4);
      ctx2.fillStyle = '#fff';
      ctx2.font = '7px Courier New';
      ctx2.textAlign = 'center';
      ctx2.fillText(n.name, s*sw + sw/2, H/2 + 3);
    }
  }
}

// ═══════════════════════════════════════════════════════
// SEQUENCER
// ═══════════════════════════════════════════════════════
function stepMs() { return (60 / bpm / 4) * 1000; }

function startSequencer() { currentStep = -1; beatInterval = setInterval(tick, stepMs()); tick(); }
function stopSequencer() {
  clearInterval(beatInterval); beatInterval = null; currentStep = -1;
  document.querySelectorAll('.beat-dot').forEach(function(d) { d.classList.remove('active'); });
  clearGrooveHighlight();
}

function tick() {
  currentStep = (currentStep + 1) % 16;
  if (currentStep % 4 === 0) {
    var qb = currentStep / 4;
    document.querySelectorAll('.beat-dot').forEach(function(d,i) { d.classList.toggle('active', i===qb); });
  }
  var grooveIdx = parseInt(document.getElementById('groove-select').value) || 0;
  var groove = GROOVES[grooveIdx];

  pads.forEach(function(pad, pi) {
    // Apply offset — shift which step this pad reads
    var effectiveStep = (currentStep - pad.offset + 16) % 16;
    if (pi === 3) {
      // Bass pad — play synth note if bassNotes set
      if (pad.bassNotes && pad.bassNotes[effectiveStep]) {
        var bn = pad.bassNotes[effectiveStep];
        var kickVal = groove.kick[effectiveStep];
        var bVel = kickVal===2 ? 0.9 : kickVal===1 ? 0.55 : 0.45;
        var stepDur = (60/bpm/4) * 0.82;
        playBassNote(bn.freq, stepDur, bVel);
      }
    } else {
      if (!pad.buffer) return;
      var rowData = getGrooveRow(groove, pad.grooveRow);
      var val = rowData[effectiveStep];
      var vel = VELOCITY[val] || 0;
      if (vel > 0) triggerPad(pi, vel);
    }
  });

  updateGrooveHighlight(currentStep);
}

// ═══════════════════════════════════════════════════════
// TRANSPORT
// ═══════════════════════════════════════════════════════
document.getElementById('play-btn').addEventListener('click', function() {
  getAudioCtx();
  if (!metroScheduler) startMetronome();
  isPlaying = !isPlaying;
  var btn = document.getElementById('play-btn');
  if (isPlaying) { btn.innerHTML = '&#9632; STOP'; btn.classList.add('playing'); startSequencer(); }
  else { btn.innerHTML = '&#9654; PLAY'; btn.classList.remove('playing'); stopSequencer(); setStatus('stopped'); }
});

document.getElementById('bpm-up').addEventListener('click',   function() { changeBpm(5);  });
document.getElementById('bpm-down').addEventListener('click', function() { changeBpm(-5); });
function changeBpm(d) {
  bpm = Math.max(40, Math.min(240, bpm+d));
  document.getElementById('bpm-display').textContent = bpm;
  if (isPlaying) { stopSequencer(); startSequencer(); }
  if (metroScheduler) restartMetronome();
}

// ═══════════════════════════════════════════════════════
// WAVEFORM
// ═══════════════════════════════════════════════════════
function drawWaveform(i) {
  var pad = pads[i];
  if (!pad.buffer || pad.isBass) return;
  var canvas = document.getElementById('wave-' + i);
  var ctx2 = canvas.getContext('2d');
  var data = pad.buffer.getChannelData(0);
  var W = canvas.width, H = canvas.height;
  ctx2.clearRect(0,0,W,H);
  ctx2.fillStyle = '#e4e4de'; ctx2.fillRect(0,0,W,H);
  ctx2.strokeStyle = '#1a1a1a'; ctx2.lineWidth = 1.2; ctx2.beginPath();
  var step = Math.ceil(data.length/W);
  for (var x = 0; x < W; x++) {
    var mn=1, mx=-1;
    for (var j=0;j<step;j++){var s=data[x*step+j]||0;if(s<mn)mn=s;if(s>mx)mx=s;}
    var y1=(1-(mx+1)/2)*H, y2=(1-(mn+1)/2)*H;
    if (x===0) ctx2.moveTo(x,y1); else ctx2.lineTo(x,y1);
    ctx2.lineTo(x,y2);
  }
  ctx2.stroke();
}
function clearWaveform(i) {
  var canvas = document.getElementById('wave-'+i);
  var ctx2 = canvas.getContext('2d');
  ctx2.clearRect(0,0,canvas.width,canvas.height);
  ctx2.fillStyle='#e4e4de'; ctx2.fillRect(0,0,canvas.width,canvas.height);
}

// ═══════════════════════════════════════════════════════
// PAD UI
// ═══════════════════════════════════════════════════════
function updatePadUI(i) {
  var pad = pads[i];
  var el       = document.getElementById('pad-'+i);
  var status   = document.getElementById('pad-status-'+i);
  var recBtn   = document.getElementById('btn-rec-'+i);
  var playBtn  = document.getElementById('btn-play-'+i);
  var clearBtn = document.getElementById('btn-clear-'+i);
  var cutBtn   = document.getElementById('btn-cut-'+i);
  var ofsBtn   = document.getElementById('btn-ofs-'+i);
  var ofsDisp  = document.getElementById('ofs-disp-'+i);

  var hasContent = pad.buffer || pad.bassNotes;
  el.classList.remove('recording','has-sample');
  if (pad.isRecording || bassCapturing && i===3) el.classList.add('recording');
  else if (hasContent) el.classList.add('has-sample');

  // Bass pad special
  if (pad.isBass) {
    el.classList.add('is-bass');
    if (hasContent) el.classList.add('has-bass');
    else el.classList.remove('has-bass');
    if (recBtn) recBtn.style.display = 'none';
  }

  if (pad.isRecording) {
    status.textContent = 'listening...';
    if (recBtn) { recBtn.innerHTML='&#9632; STOP'; recBtn.style.cssText='background:var(--red);color:white;border-color:var(--red)'; }
  } else if (hasContent) {
    if (pad.isBass && pad.bassNotes) {
      var noteList = pad.bassNotes.filter(Boolean).map(function(n){return n.name;});
      status.textContent = noteList.slice(0,4).join(' ') + (noteList.length>4?'...':'');
    } else if (pad.buffer && pad.buffer.duration) {
      status.textContent = pad.buffer.duration.toFixed(3)+'s';
    }
    if (recBtn) { recBtn.innerHTML='&#9679; REC'; recBtn.style.cssText=''; }
  } else {
    status.textContent = 'empty';
    if (recBtn) { recBtn.innerHTML='&#9679; REC'; recBtn.style.cssText=''; }
  }

  if (playBtn) playBtn.disabled = !hasContent;
  if (clearBtn) clearBtn.disabled = !hasContent;
  if (cutBtn) {
    cutBtn.disabled = !hasContent;
    cutBtn.classList.toggle('active', pad.cut);
    cutBtn.textContent = pad.cut ? 'CUT✓' : 'CUT';
  }
  if (ofsBtn) ofsBtn.classList.toggle('has-offset', pad.offset > 0);
  if (ofsDisp) {
    ofsDisp.textContent = pad.offset > 0 ? '+'+pad.offset : '';
    ofsDisp.classList.toggle('active', pad.offset > 0);
  }
}

function setStatus(msg) { document.getElementById('status-bar').textContent = msg; }

// ═══════════════════════════════════════════════════════
// BUILD UI
// ═══════════════════════════════════════════════════════
function buildUI() {
  var grid = document.getElementById('pads-grid');
  for (var i = 0; i < NUM_PADS; i++) {
    (function(idx) {
      var el = document.createElement('div');
      el.className = 'pad' + (idx===3 ? ' is-bass' : '');
      el.id = 'pad-' + idx;

      var isBass = idx === 3;

      // Row selects for pads 1-3; bass pad gets perc/kick/snare/hihat too
      var rowOpts = '<option value="kick">Kick</option><option value="snare">Snare</option><option value="hihat">Hi-hat</option><option value="perc">Perc</option>';

      // Action buttons
      var actionsHTML;
      if (isBass) {
        actionsHTML =
          '<button class="pad-btn btn-sing" id="btn-sing-' + idx + '">&#9679; SING</button>' +
          '<button class="pad-btn btn-clear" id="btn-clear-' + idx + '" disabled>&#10005;</button>' +
          '<button class="pad-btn btn-ofs has-offset" id="btn-ofs-' + idx + '">OFS</button>' +
          '<span class="ofs-display" id="ofs-disp-' + idx + '"></span>';
      } else {
        actionsHTML =
          '<button class="pad-btn btn-rec" id="btn-rec-' + idx + '">&#9679; REC</button>' +
          '<button class="pad-btn btn-play-pad" id="btn-play-' + idx + '" disabled>&#9654;</button>' +
          '<button class="pad-btn btn-clear" id="btn-clear-' + idx + '" disabled>&#10005;</button>' +
          '<button class="pad-btn btn-ofs" id="btn-ofs-' + idx + '">OFS</button>' +
          '<span class="ofs-display" id="ofs-disp-' + idx + '"></span>' +
          '<button class="pad-btn btn-cut" id="btn-cut-' + idx + '" disabled>CUT</button>';
      }

      el.innerHTML =
        '<div class="pad-header">' +
          '<div class="pad-label">' + PAD_NAMES[idx] + '</div>' +
          '<div class="pad-status" id="pad-status-' + idx + '">empty</div>' +
        '</div>' +
        (isBass
          ? '<div class="bass-pitch" id="bass-pitch-' + idx + '"></div>'
          : '<canvas class="waveform-canvas" id="wave-' + idx + '" width="300" height="64"></canvas>') +
        '<div class="pad-row-select">' +
          '<span class="row-select-label">GROOVE</span>' +
          '<select class="row-select" id="row-select-' + idx + '">' + rowOpts + '</select>' +
        '</div>' +
        '<div class="pad-actions">' + actionsHTML + '</div>';

      grid.appendChild(el);

      // Add waveform canvas for bass pad separately (used for note display)
      if (isBass) {
        var cnv = document.createElement('canvas');
        cnv.className = 'waveform-canvas'; cnv.id = 'wave-' + idx;
        cnv.width = 300; cnv.height = 64; cnv.style.display = 'none';
        el.appendChild(cnv);
      }

      var sel = document.getElementById('row-select-' + idx);
      sel.value = PAD_ROW_DEFAULTS[idx];
      sel.addEventListener('change', function(e) { pads[idx].grooveRow = e.target.value; });

      if (!isBass) {
        document.getElementById('btn-rec-' + idx).addEventListener('click', function() { toggleRecord(idx); });
        document.getElementById('btn-play-' + idx).addEventListener('click', function() { triggerPad(idx, 1.0); });
        document.getElementById('btn-cut-' + idx).addEventListener('click', function() {
          pads[idx].cut = !pads[idx].cut;
          updatePadUI(idx);
        });
      } else {
        document.getElementById('btn-sing-' + idx).addEventListener('click', function() {
          if (bassCapturing) stopBassCapture(); else toggleBassRecord();
        });
      }

      document.getElementById('btn-clear-' + idx).addEventListener('click', function() { clearPad(idx); });
      document.getElementById('btn-ofs-' + idx).addEventListener('click', function() {
        pads[idx].offset = (pads[idx].offset + 4) % 16; // shift by 1 beat (4 steps) each press, wraps at 16
        updatePadUI(idx);
        setStatus('pad '+(idx+1)+' offset: +'+ pads[idx].offset + ' steps');
      });

    })(i);
  }
}

// ═══════════════════════════════════════════════════════
// GROOVE GUIDE
// ═══════════════════════════════════════════════════════
function buildGrooveSelector() {
  var sel = document.getElementById('groove-select');
  GROOVES.forEach(function(g, i) {
    var opt = document.createElement('option');
    opt.value = i; opt.textContent = g.name; sel.appendChild(opt);
  });
  sel.addEventListener('change', function() { renderGroove(parseInt(sel.value)); });
  var labelsEl = document.getElementById('groove-beat-labels');
  var names = ['1','e','+','a','2','e','+','a','3','e','+','a','4','e','+','a'];
  for (var b = 0; b < 16; b++) {
    var lbl = document.createElement('div'); lbl.className = 'groove-beat-label';
    lbl.textContent = names[b];
    if (b%4===0) lbl.style.color='var(--text)';
    labelsEl.appendChild(lbl);
  }
  renderGroove(0);
}

function renderGroove(idx) {
  var g = GROOVES[idx];
  document.getElementById('groove-desc').textContent = g.desc;
  var gridEl = document.getElementById('groove-grid'); gridEl.innerHTML = '';
  [['KICK',getGrooveRow(g,'kick')],['SNARE',getGrooveRow(g,'snare')],['HIHAT',getGrooveRow(g,'hihat')],['PERC',getGrooveRow(g,'perc')]].forEach(function(pair) {
    var rowEl = document.createElement('div'); rowEl.className = 'groove-row-el';
    var lbl = document.createElement('div'); lbl.className = 'groove-row-label'; lbl.textContent = pair[0];
    var stepsEl = document.createElement('div'); stepsEl.className = 'groove-steps';
    pair[1].forEach(function(val, si) {
      var s = document.createElement('div'); s.className = 'groove-step';
      if (si>0 && si%4===0) s.classList.add('beat-gap');
      if (val===1) s.classList.add('on'); if (val===2) s.classList.add('accent');
      stepsEl.appendChild(s);
    });
    rowEl.appendChild(lbl); rowEl.appendChild(stepsEl); gridEl.appendChild(rowEl);
  });
}

function updateGrooveHighlight(step) {
  document.querySelectorAll('.groove-steps').forEach(function(stepsEl) {
    stepsEl.querySelectorAll('.groove-step').forEach(function(el,i) { el.classList.toggle('now', i===step); });
  });
}
function clearGrooveHighlight() { document.querySelectorAll('.groove-step').forEach(function(el) { el.classList.remove('now'); }); }

document.getElementById('groove-header').addEventListener('click', function() {
  document.getElementById('groove-panel').classList.toggle('open');
});

// ═══════════════════════════════════════════════════════
// KEYBOARD
// ═══════════════════════════════════════════════════════
document.addEventListener('keydown', function(e) {
  var key = e.key.toUpperCase();
  var i = PAD_KEYS.indexOf(key);
  if (i !== -1 && i < 3) triggerPad(i, 1.0);
  if (key===' ') { e.preventDefault(); document.getElementById('play-btn').click(); }
  if (key==='M') document.getElementById('metro-btn').click();
});

// ═══════════════════════════════════════════════════════
// INIT
// ═══════════════════════════════════════════════════════
buildUI();
buildGrooveSelector();

var micPermissionGranted = false;
function prewarmMic() {
  if (micPermissionGranted) return;
  navigator.mediaDevices.getUserMedia({ audio: true, video: false })
    .then(function(stream) { micStream = stream; micPermissionGranted = true; setStatus('mic ready — press REC or SING'); })
    .catch(function() { setStatus('mic denied — check permissions'); });
}
document.addEventListener('click', function() { prewarmMic(); }, { once: true });
setStatus('tap anywhere to enable mic  |  M = mute click');
</script>
</body>
</html>
