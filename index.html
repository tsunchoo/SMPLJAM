<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>SMPLJAK</title>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg: #0d0d0d; --panel: #161616; --border: #2a2a2a;
  --accent: #e8ff3a; --red: #ff3a3a; --red-dark: #3a0000;
  --text: #f0f0f0; --sub: #777; --dim: #333;
  --green: #3aff8a; --green-dark: #002210;
  --btn-bg: #ccccc4; --btn-text: #111;
}
body {
  background: var(--bg); color: var(--text);
  font-family: 'Courier New', Courier, monospace;
  min-height: 100vh; display: flex; flex-direction: column;
  align-items: center; padding: 12px 10px 20px;
  user-select: none; -webkit-user-select: none; touch-action: manipulation;
}
header { text-align: center; margin-bottom: 10px; }
h1 { font-family: Impact, 'Arial Black', sans-serif; font-size: 42px; letter-spacing: 7px; color: var(--accent); line-height: 1; }
.tagline { font-size: 9px; color: var(--sub); letter-spacing: 4px; text-transform: uppercase; margin-top: 2px; }

.transport {
  display: flex; align-items: center; gap: 6px;
  background: var(--panel); border: 1px solid var(--border);
  padding: 8px 12px; border-radius: 4px;
  width: 100%; max-width: 540px; margin-bottom: 10px;
  justify-content: center; flex-wrap: wrap;
}
.bpm-group { display: flex; align-items: center; gap: 5px; }
.bpm-label { font-size: 9px; color: var(--sub); letter-spacing: 2px; }
.bpm-display { font-family: Impact, 'Arial Black', sans-serif; font-size: 28px; color: var(--accent); width: 52px; text-align: center; }
.bpm-controls { display: flex; flex-direction: column; gap: 2px; }
.bpm-btn { background: none; border: 1px solid var(--border); color: var(--text); font-size: 9px; padding: 2px 7px; cursor: pointer; border-radius: 2px; }
.bpm-btn:hover { border-color: var(--accent); color: var(--accent); }
.divider { width: 1px; height: 32px; background: var(--border); flex-shrink: 0; }

.t-btn {
  font-family: 'Courier New', Courier, monospace;
  font-size: 11px; font-weight: bold; letter-spacing: 1px;
  padding: 7px 12px; border-radius: 3px; cursor: pointer;
  border: 1px solid var(--border); color: var(--sub);
  background: var(--panel); text-transform: uppercase;
  transition: all 0.12s; white-space: nowrap;
}
.t-btn:hover { border-color: var(--text); color: var(--text); }
.t-btn.active { background: var(--red); color: #fff; border-color: var(--red); }

.groove-sel {
  font-family: 'Courier New', Courier, monospace;
  font-size: 11px; font-weight: bold;
  padding: 7px 8px; border-radius: 3px; cursor: pointer;
  border: 1px solid var(--border); color: var(--sub);
  background: var(--panel); letter-spacing: 1px;
  -webkit-appearance: none; appearance: none; min-width: 110px;
}
.groove-sel:focus { outline: none; border-color: var(--accent); color: var(--text); }

.beat-dots { display: flex; gap: 5px; align-items: center; }
.beat-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--border); transition: background 0.05s; }
.beat-dot.active { background: var(--accent); }

.pads-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; width: 100%; max-width: 540px; }
.pad-cell { display: flex; flex-direction: column; gap: 4px; }

.pad-tap {
  position: relative; border-radius: 4px; overflow: hidden;
  height: 112px; cursor: pointer;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  border: 2px solid var(--border); background: var(--panel);
  transition: border-color 0.15s, background 0.15s;
  -webkit-tap-highlight-color: transparent;
}
.pad-tap.st-empty { border-color: var(--border);   background: var(--panel); }
.pad-tap.st-beep  { border-color: var(--red-dark); background: #1a0000; }
.pad-tap.st-rec   { border-color: var(--red);      background: #160000; animation: prec 0.45s infinite alternate; }
.pad-tap.st-proc  { border-color: var(--red-dark); background: #1a0000; }
.pad-tap.st-play  { border-color: var(--green);    background: var(--green-dark); }
@keyframes prec { from{box-shadow:none} to{box-shadow:0 0 16px 5px rgba(255,58,58,0.45)} }
.pad-tap::before { content:''; position:absolute; inset:0; background:var(--accent); opacity:0; pointer-events:none; transition:opacity 0.05s; }
.pad-tap.flash::before      { opacity:0.2; }
.pad-tap.flash-soft::before { opacity:0.08; }
.pad-tap canvas { position:absolute; inset:0; width:100%; height:100%; opacity:0; pointer-events:none; }
.pad-tap.st-play canvas { opacity:0.5; }
.pad-tap.st-rec  canvas { opacity:0.55; }
.pad-num {
  position:relative; z-index:2; pointer-events:none;
  font-family:Impact,'Arial Black',sans-serif; font-size:38px; letter-spacing:2px;
  transition:color 0.15s;
}
.pad-tap.st-empty .pad-num { color:var(--dim); }
.pad-tap.st-beep  .pad-num { color:#2a0000; }
.pad-tap.st-rec   .pad-num { color:var(--red); }
.pad-tap.st-proc  .pad-num { color:#2a0000; }
.pad-tap.st-play  .pad-num { color:var(--green); }
.pad-info { position:relative; z-index:2; pointer-events:none; font-size:8px; letter-spacing:1px; margin-top:4px; color:transparent; transition:color 0.15s; }
.pad-tap.st-play .pad-info { color:var(--green); }
.pad-tap.st-rec  .pad-info { color:var(--red); }

.pad-sub { display:grid; grid-template-columns:repeat(4,1fr); gap:3px; }
.sub-btn {
  font-family:'Courier New',Courier,monospace; font-size:11px; font-weight:bold;
  padding:8px 2px; border-radius:3px; cursor:pointer; border:none;
  background:var(--btn-bg); color:var(--btn-text);
  text-transform:uppercase; transition:background 0.1s,color 0.1s; text-align:center;
}
.sub-btn:disabled { opacity:0.25; cursor:default; pointer-events:none; }
.sub-btn.is-active { background:var(--red) !important; color:#fff !important; }
.sub-btn.del-btn:not(:disabled) { background:#e8b0b0; }
.sub-btn.del-btn:not(:disabled):hover { background:var(--red); color:#fff; }

.status-bar { margin-top:8px; font-size:9px; color:var(--sub); letter-spacing:1px; text-align:center; min-height:14px; width:100%; max-width:540px; }
</style>
</head>
<body>
<header>
  <h1>SMPLJAK</h1>
  <div class="tagline">groove sampler</div>
</header>

<div class="transport">
  <div class="bpm-group">
    <span class="bpm-label">BPM</span>
    <div class="bpm-display" id="bpm-display">120</div>
    <div class="bpm-controls">
      <button class="bpm-btn" id="bpm-up">&#9650;</button>
      <button class="bpm-btn" id="bpm-down">&#9660;</button>
    </div>
  </div>
  <div class="divider"></div>
  <button class="t-btn" id="metro-btn">CLICK</button>
  <div class="divider"></div>
  <select class="groove-sel" id="groove-select"></select>
  <div class="divider"></div>
  <div class="beat-dots">
    <div class="beat-dot" id="dot-0"></div>
    <div class="beat-dot" id="dot-1"></div>
    <div class="beat-dot" id="dot-2"></div>
    <div class="beat-dot" id="dot-3"></div>
  </div>
</div>

<div class="pads-grid" id="pads-grid"></div>
<div class="status-bar" id="status-bar">hold a pad to record</div>

<script>
var PAD_ROWS = ['kick','snare','hihat','kick'];
var VELOCITY = [0, 0.42, 1.0];
var bpm = 120, isPlaying = false, currentStep = -1, beatInterval = null;
var audioCtx = null, micStream = null;
var metroMuted = false, metroScheduler = null, metroNextTime = 0, metroBeat = 0, metroGain = null;
var masterGain = null, masterLimiter = null;

var pads = [];
for (var _i = 0; _i < 4; _i++) {
  pads.push({
    index:_i, isBass:_i===3,
    buffer:null,      // AudioBuffer (real recording for all pads)
    bassNotes:null,   // [{freq,start,dur}] phrase for pad 4 synth
    state:'empty', offset:0, cut:false, muted:false,
    pcmChunks:[], scriptRecorder:null, muteGain:null,
    analyser:null, analyserSource:null, liveAnimFrame:null, recTimer:null
  });
}

// ── Grooves ──────────────────────────────────────────────
var GROOVES = [
  {name:"Hold On",      kick:[2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],snare:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],hihat:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]},
  {name:"Basic Rock",   kick:[2,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0],snare:[0,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0],hihat:[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0]},
  {name:"Funk",         kick:[2,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0],snare:[0,0,0,0,2,0,0,1,0,0,0,0,2,0,1,0],hihat:[2,1,1,1,1,2,1,1,2,1,1,1,1,2,1,1]},
  {name:"Hip-Hop",      kick:[2,0,0,0,0,0,1,0,2,0,0,0,0,1,0,0],snare:[0,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0],hihat:[1,0,1,0,0,1,0,0,1,0,1,0,0,1,0,1]},
  {name:"Trap",         kick:[2,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0],snare:[0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0],hihat:[1,1,2,1,1,1,2,1,1,1,2,1,1,1,2,1]},
  {name:"Four-on-Floor",kick:[2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0],snare:[0,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0],hihat:[1,1,2,1,1,1,2,1,1,1,2,1,1,1,2,1]},
  {name:"Disco",        kick:[2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0],snare:[0,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0],hihat:[1,0,2,0,1,0,2,0,1,0,2,0,1,0,2,0]},
  {name:"Shuffle",      kick:[2,0,1,0,0,1,0,0,2,0,1,0,0,1,0,0],snare:[0,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0],hihat:[1,0,2,0,1,0,2,0,1,0,2,0,1,0,2,0]},
  {name:"Jazz Swing",   kick:[2,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],snare:[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],hihat:[2,0,1,0,2,0,1,0,2,0,1,0,2,0,1,0]},
  {name:"Reggae",       kick:[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],snare:[0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0],hihat:[0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0]},
  {name:"Bossa Nova",   kick:[2,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0],snare:[0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0],hihat:[1,1,0,1,1,0,1,1,0,1,1,0,1,1,0,1]},
  {name:"Breakbeat",    kick:[2,0,0,0,0,0,1,0,0,0,2,0,0,1,0,0],snare:[0,0,0,0,2,0,0,1,0,0,0,0,1,1,0,0],hihat:[2,1,1,1,1,1,1,1,2,1,1,1,1,1,1,1]},
  {name:"Trip-Hop",     kick:[2,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0],snare:[0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0],hihat:[1,0,0,0,1,0,0,0,1,0,0,0,0,0,1,0]},
  {name:"2-Step",       kick:[2,0,0,0,0,1,0,0,2,0,0,1,0,0,0,0],snare:[0,0,0,0,0,0,2,0,0,0,0,0,0,0,2,0],hihat:[1,0,1,1,0,1,0,1,1,0,1,1,0,1,0,1]},
  {name:"Afrobeat",     kick:[2,0,0,1,0,0,1,0,0,0,2,0,0,1,0,0],snare:[0,0,0,0,1,0,0,0,1,0,0,0,0,0,1,0],hihat:[2,0,1,0,1,0,2,0,1,0,1,0,2,0,1,0]},
  {name:"Samba",        kick:[2,0,1,0,0,1,0,1,2,0,1,0,0,1,0,0],snare:[0,1,0,0,2,0,1,0,0,1,0,0,2,0,1,0],hihat:[2,1,1,1,2,1,1,1,2,1,1,1,2,1,1,1]},
];

// ── Audio context + master chain ─────────────────────────
function getAudioCtx() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    masterGain = audioCtx.createGain(); masterGain.gain.value = 1.0;
    masterLimiter = audioCtx.createDynamicsCompressor();
    masterLimiter.threshold.value=-3; masterLimiter.knee.value=2;
    masterLimiter.ratio.value=20; masterLimiter.attack.value=0.001; masterLimiter.release.value=0.1;
    masterGain.connect(masterLimiter); masterLimiter.connect(audioCtx.destination);
    metroGain = audioCtx.createGain(); metroGain.gain.value = metroMuted?0:1;
    metroGain.connect(masterGain);
  }
  if (audioCtx.state==='suspended') audioCtx.resume();
  return audioCtx;
}
function duckMaster(on) {
  if (!masterGain) return;
  masterGain.gain.setTargetAtTime(on?0.5:1.0, audioCtx.currentTime, 0.04);
}
async function getMic() {
  if (micStream) return micStream;
  try {
    micStream = await navigator.mediaDevices.getUserMedia({
      audio:{echoCancellation:true, noiseSuppression:false, autoGainControl:false}, video:false
    });
    return micStream;
  } catch(e) { setStatus('mic denied'); return null; }
}

// ── Metronome ────────────────────────────────────────────
function scheduleClick(time, accent) {
  var ctx=getAudioCtx(), osc=ctx.createOscillator(), env=ctx.createGain();
  osc.connect(env); env.connect(metroGain);
  osc.frequency.value=accent?1200:900; osc.type='sine';
  env.gain.setValueAtTime(0,time); env.gain.linearRampToValueAtTime(0.5,time+0.003); env.gain.exponentialRampToValueAtTime(0.001,time+0.06);
  osc.start(time); osc.stop(time+0.08);
}
function startMetronome() {
  var ctx=getAudioCtx(); metroBeat=0; metroNextTime=ctx.currentTime+0.05;
  function sched(){while(metroNextTime<ctx.currentTime+0.2){scheduleClick(metroNextTime,metroBeat%4===0);metroBeat++;metroNextTime+=60.0/bpm;}}
  metroScheduler=setInterval(sched,50); sched();
}
function stopMetronome(){if(metroScheduler){clearInterval(metroScheduler);metroScheduler=null;}}
function restartMetronome(){stopMetronome();if(isPlaying)startMetronome();}

function playBeep(cb) {
  var ctx=getAudioCtx(), now=ctx.currentTime;
  var osc=ctx.createOscillator(), env=ctx.createGain();
  osc.connect(env); env.connect(masterGain);
  osc.type='sine'; osc.frequency.value=880;
  env.gain.setValueAtTime(0,now); env.gain.linearRampToValueAtTime(0.15,now+0.01); env.gain.exponentialRampToValueAtTime(0.001,now+0.10);
  osc.start(now); osc.stop(now+0.12);
  setTimeout(cb, 140);
}

document.getElementById('metro-btn').addEventListener('click', function(){
  metroMuted=!metroMuted;
  this.classList.toggle('active', metroMuted);
  if (metroGain) metroGain.gain.setTargetAtTime(metroMuted?0:1, getAudioCtx().currentTime, 0.02);
});

// ── Live viz ─────────────────────────────────────────────
function startLiveViz(pad) {
  var canvas=document.getElementById('wave-'+pad.index); if(!canvas) return;
  var c=canvas.getContext('2d'), analyser=pad.analyser;
  var bufLen=analyser.frequencyBinCount, data=new Uint8Array(bufLen);
  var W=canvas.width, H=canvas.height, hist=new Float32Array(W), hp=0;
  function draw(){
    if(pad.state!=='rec') return;
    pad.liveAnimFrame=requestAnimationFrame(draw);
    analyser.getByteTimeDomainData(data);
    var s=0; for(var k=0;k<bufLen;k++){var v=(data[k]/128.0)-1.0;s+=v*v;}
    hist[hp%W]=Math.sqrt(s/bufLen); hp++;
    c.clearRect(0,0,W,H); var mid=H/2;
    for(var x=0;x<W;x++){
      var rms=hist[(hp-W+x+W*4)%W], amp=Math.min(rms*H*4,mid);
      c.fillStyle='rgba(255,58,58,'+(0.4+(x/W)*0.6)+')';
      c.fillRect(x,mid-amp,1,Math.max(amp*2,1));
    }
  }
  draw();
}
function stopLiveViz(pad){
  if(pad.liveAnimFrame){cancelAnimationFrame(pad.liveAnimFrame);pad.liveAnimFrame=null;}
  if(pad.analyserSource){try{pad.analyserSource.disconnect();}catch(e){} pad.analyserSource=null;}
  pad.analyser=null;
}

// ── PCM recording ────────────────────────────────────────
function startPCMRecord(pad, stream) {
  var ctx=getAudioCtx();
  var source=ctx.createMediaStreamSource(stream);
  // High-pass to kill DC offset
  var hp=ctx.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=60;
  source.connect(hp);
  var analyser=ctx.createAnalyser(); analyser.fftSize=2048;
  hp.connect(analyser); pad.analyser=analyser; pad.analyserSource=source;
  var recorder=ctx.createScriptProcessor(2048,1,1);
  recorder.onaudioprocess=function(e){
    if(pad.state==='rec') pad.pcmChunks.push(new Float32Array(e.inputBuffer.getChannelData(0)));
  };
  var mute=ctx.createGain(); mute.gain.value=0;
  hp.connect(recorder); recorder.connect(mute); mute.connect(ctx.destination);
  pad.scriptRecorder=recorder; pad.muteGain=mute;
}
function stopPCMRecord(pad){
  if(pad.scriptRecorder){try{pad.scriptRecorder.disconnect();}catch(e){} pad.scriptRecorder=null;}
  if(pad.muteGain){try{pad.muteGain.disconnect();}catch(e){} pad.muteGain=null;}
  stopLiveViz(pad);
}

// ── Buffer utils ─────────────────────────────────────────
function chunksToBuffer(chunks){
  var total=0; for(var i=0;i<chunks.length;i++) total+=chunks[i].length;
  var combined=new Float32Array(total), off=0;
  for(var j=0;j<chunks.length;j++){combined.set(chunks[j],off);off+=chunks[j].length;}
  var ctx=getAudioCtx(), buf=ctx.createBuffer(1,combined.length,ctx.sampleRate);
  buf.getChannelData(0).set(combined); return buf;
}
function trimSilence(buf){
  var data=buf.getChannelData(0), sr=buf.sampleRate;
  var peak=0; for(var p=0;p<data.length;p++){var ap=Math.abs(data[p]);if(ap>peak)peak=ap;}
  if(peak<0.001) return buf;
  var thr=peak*0.04, win=Math.max(Math.floor(sr*0.003),1), start=-1;
  for(var n=0;n<data.length-win;n+=win){
    var ws=0; for(var w=0;w<win;w++) ws+=data[n+w]*data[n+w];
    if(Math.sqrt(ws/win)>thr){start=Math.max(0,n-win);break;}
  }
  if(start<=0) return buf;
  var ctx=getAudioCtx(), nc=buf.numberOfChannels, newLen=buf.length-start;
  if(newLen<=0) return buf;
  var out=ctx.createBuffer(nc,newLen,sr);
  for(var c=0;c<nc;c++){var src=buf.getChannelData(c),dst=out.getChannelData(c);for(var s=0;s<newLen;s++) dst[s]=src[start+s];}
  return out;
}

// ── Bass phrase analysis ──────────────────────────────────
// After recording, slice into 80ms windows, pitch-detect each,
// merge runs of the same note → array of timed events.
function pitchOfWindow(norm, offset, winLen, sr) {
  var minLag=Math.floor(sr/500), maxLag=Math.floor(sr/55);
  if(maxLag>=winLen) maxLag=winLen-1;
  // RMS gate
  var rms=0; for(var i=0;i<winLen;i++) rms+=norm[offset+i]*norm[offset+i];
  rms=Math.sqrt(rms/winLen);
  if(rms<0.04) return null;
  // Mean-subtracted autocorrelation
  var mean=0; for(var ii=0;ii<winLen;ii++) mean+=norm[offset+ii]; mean/=winLen;
  var HALF=Math.floor(winLen/2);
  var power=0; for(var k=0;k<HALF;k++){var d=norm[offset+k]-mean; power+=d*d;}
  if(power<0.0001) return null;
  var bestLag=-1, bestC=-Infinity;
  for(var lag=minLag;lag<=maxLag;lag++){
    var c=0; for(var j=0;j<HALF;j++) c+=(norm[offset+j]-mean)*(norm[offset+j+lag]-mean);
    if(c>bestC){bestC=c;bestLag=lag;}
  }
  if(bestLag===-1||bestC/power<0.20) return null; // weak periodicity
  var rawHz=sr/bestLag;
  var midi=Math.round(12*Math.log2(rawHz/440)+69);
  midi=Math.max(24,Math.min(60,midi)); // C1–C4
  return 440*Math.pow(2,(midi-69)/12);
}

function analyseBassPhrase(audioBuffer) {
  var data=audioBuffer.getChannelData(0), sr=audioBuffer.sampleRate;
  // Normalise to peak
  var peak=0; for(var i=0;i<data.length;i++){var a=Math.abs(data[i]);if(a>peak)peak=a;}
  if(peak<0.002) return null;
  var norm=new Float32Array(data.length);
  for(var j=0;j<data.length;j++) norm[j]=data[j]/peak;

  var segSamples=Math.floor(sr*0.08); // 80ms windows
  var events=[];
  for(var s=0; s+segSamples<norm.length; s+=segSamples){
    events.push({freq:pitchOfWindow(norm,s,segSamples,sr), tSec:s/sr});
  }

  // Merge consecutive windows with same note (within 1 semitone)
  var merged=[], cur=null;
  for(var n=0;n<events.length;n++){
    var ev=events[n];
    if(!ev.freq){cur=null;continue;}
    if(cur&&Math.abs(12*Math.log2(ev.freq/cur.freq))<0.7){
      cur.endSec=ev.tSec+0.08;
    } else {
      cur={freq:ev.freq, startSec:ev.tSec, endSec:ev.tSec+0.08};
      merged.push(cur);
    }
  }
  // Filter very short events (<60ms)
  merged=merged.filter(function(m){return m.endSec-m.startSec>=0.06;});
  if(merged.length===0) return null;

  var totalDur=audioBuffer.duration;
  return merged.map(function(m){
    return {
      freq: m.freq/2,                      // one octave lower
      start: m.startSec/totalDur,          // 0–1 fraction of bar
      dur:   (m.endSec-m.startSec)/totalDur
    };
  });
}

// ── Bass synth — sine, octave lower ──────────────────────
function playBassNote(freq, durSec, vel) {
  if(!freq||freq<10) return;
  var ctx=getAudioCtx(), now=ctx.currentTime;
  var osc=ctx.createOscillator(), gain=ctx.createGain();
  osc.type='sine'; osc.frequency.value=freq;
  gain.gain.setValueAtTime(0,now);
  gain.gain.linearRampToValueAtTime(vel*0.8,now+0.015);
  gain.gain.setValueAtTime(vel*0.8,now+durSec*0.65);
  gain.gain.exponentialRampToValueAtTime(0.001,now+durSec*0.98);
  osc.connect(gain); gain.connect(masterGain);
  osc.start(now); osc.stop(now+durSec);
}

// ── Hold recording — pads 0-2 (max 1 beat) ───────────────
function oneBeatMs(){return (60/bpm)*1000;}
function barMs(){return oneBeatMs()*16;}

function ensureSequencer(){
  if(!isPlaying){
    isPlaying=true;
    startMetronome();
    startSequencer();
  }
}

function padHoldStart(idx){
  var pad=pads[idx];
  if(pad.state==='rec'||pad.state==='beep') return;
  getAudioCtx();
  pad.state='beep'; updatePadUI(idx); duckMaster(true);
  playBeep(function(){
    if(pad.state!=='beep') return;
    getMic().then(function(stream){
      if(!stream||pad.state!=='beep'){pad.state=pad.buffer?'play':'empty';updatePadUI(idx);duckMaster(false);return;}
      pad.pcmChunks=[]; pad.state='rec'; updatePadUI(idx);
      startPCMRecord(pad,stream); startLiveViz(pad);
      pad.recTimer=setTimeout(function(){padHoldEnd(idx);},oneBeatMs());
    });
  });
}
function padHoldEnd(idx){
  var pad=pads[idx];
  if(pad.recTimer){clearTimeout(pad.recTimer);pad.recTimer=null;}
  if(pad.state==='beep'){pad.state=pad.buffer?'play':'empty';updatePadUI(idx);duckMaster(false);return;}
  if(pad.state!=='rec') return;
  pad.state='proc'; updatePadUI(idx); stopPCMRecord(pad); duckMaster(false);
  if(pad.pcmChunks.length===0){pad.state=pad.buffer?'play':'empty';updatePadUI(idx);return;}
  pad.buffer=trimSilence(chunksToBuffer(pad.pcmChunks)); pad.pcmChunks=[];
  pad.state='play'; drawWaveform(idx); updatePadUI(idx);
  ensureSequencer();
  setStatus((idx+1)+' ready — '+pad.buffer.duration.toFixed(2)+'s');
}

// ── Hold recording — pad 3 bass (max 4 bars) ─────────────
function bassHoldStart(){
  var pad=pads[3];
  if(pad.state==='rec'||pad.state==='beep') return;
  getAudioCtx();
  pad.state='beep'; updatePadUI(3); duckMaster(true);
  playBeep(function(){
    if(pad.state!=='beep') return;
    getMic().then(function(stream){
      if(!stream||pad.state!=='beep'){pad.state=pad.buffer?'play':'empty';updatePadUI(3);duckMaster(false);return;}
      pad.pcmChunks=[]; pad.state='rec'; updatePadUI(3);
      startPCMRecord(pad,stream); startLiveViz(pad);
      pad.recTimer=setTimeout(function(){bassHoldEnd();},barMs());
    });
  });
}
function bassHoldEnd(){
  var pad=pads[3];
  if(pad.recTimer){clearTimeout(pad.recTimer);pad.recTimer=null;}
  if(pad.state==='beep'){pad.state=pad.buffer?'play':'empty';updatePadUI(3);duckMaster(false);return;}
  if(pad.state!=='rec') return;
  pad.state='proc'; updatePadUI(3); stopPCMRecord(pad); duckMaster(false);
  if(pad.pcmChunks.length===0){pad.state=pad.buffer?'play':'empty';updatePadUI(3);return;}
  pad.buffer=trimSilence(chunksToBuffer(pad.pcmChunks)); pad.pcmChunks=[];
  // Post-hoc phrase analysis — runs once, ~5-20ms on phone
  pad.bassNotes=analyseBassPhrase(pad.buffer);
  pad.state='play'; drawWaveform(3); updatePadUI(3);
  ensureSequencer();
  if(pad.bassNotes){
    setStatus('bass: '+pad.bassNotes.length+' note'+(pad.bassNotes.length!==1?'s':'')+' found');
  } else {
    setStatus('bass: no pitch detected — playing raw');
  }
}

// ── Playback ─────────────────────────────────────────────
function triggerPad(idx, vel){
  var pad=pads[idx];
  if(!pad.buffer||vel<=0||pad.muted) return;
  var ctx=getAudioCtx(), src=ctx.createBufferSource(); src.buffer=pad.buffer;
  var gain=ctx.createGain(); gain.gain.value=Math.min(vel,1.0);
  src.connect(gain); gain.connect(masterGain);
  if(pad.cut){
    var half=pad.buffer.duration*0.5, fadeAt=half*0.8;
    gain.gain.setValueAtTime(vel,ctx.currentTime+fadeAt);
    gain.gain.linearRampToValueAtTime(0.0001,ctx.currentTime+half);
    src.start(); src.stop(ctx.currentTime+half);
  } else { src.start(); }
  var tapEl=document.getElementById('pad-tap-'+idx);
  tapEl.classList.add(vel>0.7?'flash':'flash-soft');
  setTimeout(function(){tapEl.classList.remove('flash','flash-soft');},vel>0.7?100:60);
}

function clearPad(idx){
  var pad=pads[idx];
  if(pad.recTimer){clearTimeout(pad.recTimer);pad.recTimer=null;}
  pad.buffer=null; pad.bassNotes=null; pad.state='empty';
  pad.offset=0; pad.cut=false; pad.muted=false;
  clearWaveform(idx); updatePadUI(idx);
}

// ── Sequencer ────────────────────────────────────────────
function stepMs(){return (60/bpm/4)*1000;}
function startSequencer(){currentStep=-1;beatInterval=setInterval(tick,stepMs());tick();}
function stopSequencer(){
  clearInterval(beatInterval);beatInterval=null;currentStep=-1;
  document.querySelectorAll('.beat-dot').forEach(function(d){d.classList.remove('active');});
}

function tick(){
  currentStep=(currentStep+1)%16;
  if(currentStep%4===0){
    var qb=currentStep/4;
    document.querySelectorAll('.beat-dot').forEach(function(d,i){d.classList.toggle('active',i===qb);});
  }
  var gi=parseInt(document.getElementById('groove-select').value)||0;
  var groove=GROOVES[gi];

  // Pads 0-2
  for(var pi=0;pi<3;pi++){
    var pad=pads[pi];
    if(pad.state!=='play'||!pad.buffer||pad.muted) continue;
    var step=(currentStep-pad.offset+16)%16;
    var vel=VELOCITY[groove[PAD_ROWS[pi]][step]]||0;
    if(vel>0) triggerPad(pi,vel);
  }

  // Pad 3 bass — on every kick hit, schedule phrase from that point
  var bp=pads[3];
  if(bp.state==='play'&&bp.buffer&&!bp.muted){
    var step3=(currentStep-bp.offset+16)%16;
    var kv=groove.kick[step3];
    if(kv>0){
      var vel3=kv===2?0.85:0.55;
      if(bp.bassNotes){
        // Only launch the phrase on step 0 (downbeat) to avoid overlaps
        if(step3===0){
          var bms=barMs();
          bp.bassNotes.forEach(function(bn){
            var delayMs=bn.start*bms;
            var durSec=Math.max(bn.dur*bms/1000, 0.06);
            setTimeout(function(){
              if(bp.state==='play'&&!bp.muted) playBassNote(bn.freq, durSec, vel3);
            }, delayMs);
          });
        }
      } else {
        // Fallback: play raw audio sample
        triggerPad(3, vel3);
      }
    }
  }
}

// ── BPM ──────────────────────────────────────────────────
document.getElementById('bpm-up').addEventListener('click',  function(){changeBpm(5);});
document.getElementById('bpm-down').addEventListener('click',function(){changeBpm(-5);});
function changeBpm(d){
  bpm=Math.max(40,Math.min(240,bpm+d));
  document.getElementById('bpm-display').textContent=bpm;
  if(isPlaying){stopSequencer();startSequencer();}
  restartMetronome();
}

// ── Waveform ─────────────────────────────────────────────
function drawWaveform(idx){
  var pad=pads[idx]; if(!pad.buffer) return;
  var canvas=document.getElementById('wave-'+idx), c=canvas.getContext('2d');
  var data=pad.buffer.getChannelData(0), W=canvas.width, H=canvas.height;
  c.clearRect(0,0,W,H); c.strokeStyle='#3aff8a'; c.lineWidth=1.5; c.beginPath();
  var step=Math.ceil(data.length/W);
  for(var x=0;x<W;x++){
    var mn=1,mx=-1; for(var j=0;j<step;j++){var s=data[x*step+j]||0;if(s<mn)mn=s;if(s>mx)mx=s;}
    var y1=(1-(mx+1)/2)*H, y2=(1-(mn+1)/2)*H;
    if(x===0)c.moveTo(x,y1);else c.lineTo(x,y1); c.lineTo(x,y2);
  }
  c.stroke();
}
function clearWaveform(idx){var cv=document.getElementById('wave-'+idx);cv.getContext('2d').clearRect(0,0,cv.width,cv.height);}

// ── Pad UI ────────────────────────────────────────────────
function updatePadUI(idx){
  var pad=pads[idx];
  var tapEl  =document.getElementById('pad-tap-'+idx);
  var infoEl =document.getElementById('pad-info-'+idx);
  var delBtn =document.getElementById('sub-del-'+idx);
  var cutBtn =document.getElementById('sub-cut-'+idx);
  var ofs1   =document.getElementById('sub-ofs1-'+idx);
  var ofs2   =document.getElementById('sub-ofs2-'+idx);
  var muteBtn=document.getElementById('sub-mute-'+idx);

  tapEl.className='pad-tap st-'+pad.state;

  if(pad.state==='play'){
    if(pad.isBass&&pad.bassNotes) infoEl.textContent=pad.bassNotes.length+' notes';
    else if(pad.buffer&&pad.buffer.duration) infoEl.textContent=pad.buffer.duration.toFixed(2)+'s';
    else infoEl.textContent='';
  } else if(pad.state==='rec'){
    infoEl.textContent='rec…';
  } else { infoEl.textContent=''; }

  var has=!!pad.buffer;
  if(delBtn)  delBtn.disabled=!has;
  if(cutBtn)  {cutBtn.disabled=!has;cutBtn.classList.toggle('is-active',pad.cut);}
  if(ofs1)    {ofs1.disabled=!has;ofs1.classList.toggle('is-active',pad.offset===4);}
  if(ofs2)    {ofs2.disabled=!has;ofs2.classList.toggle('is-active',pad.offset===8);}
  if(muteBtn) {muteBtn.disabled=!has;muteBtn.classList.toggle('is-active',pad.muted);}
}
function setStatus(msg){document.getElementById('status-bar').textContent=msg;}

// ── Build UI ─────────────────────────────────────────────
function buildUI(){
  var grid=document.getElementById('pads-grid');
  for(var i=0;i<4;i++){
    (function(idx){
      var isBass=idx===3;
      var cell=document.createElement('div'); cell.className='pad-cell';
      var tap=document.createElement('div'); tap.className='pad-tap st-empty'; tap.id='pad-tap-'+idx;
      var canvas=document.createElement('canvas'); canvas.id='wave-'+idx; canvas.width=300; canvas.height=112;
      var numEl=document.createElement('div'); numEl.className='pad-num'; numEl.id='pad-num-'+idx; numEl.textContent=idx+1;
      var infoEl=document.createElement('div'); infoEl.className='pad-info'; infoEl.id='pad-info-'+idx;
      tap.appendChild(canvas); tap.appendChild(numEl); tap.appendChild(infoEl);

      var held=false;
      function onDown(e){e.preventDefault();if(held)return;held=true;isBass?bassHoldStart():padHoldStart(idx);}
      function onUp(e)  {e.preventDefault();if(!held)return;held=false;isBass?bassHoldEnd():padHoldEnd(idx);}
      tap.addEventListener('mousedown',  onDown);
      tap.addEventListener('mouseup',    onUp);
      tap.addEventListener('touchstart', onDown,{passive:false});
      tap.addEventListener('touchend',   onUp,  {passive:false});
      tap.addEventListener('touchcancel',onUp,  {passive:false});

      var sub=document.createElement('div'); sub.className='pad-sub';
      var b2id =isBass?'sub-mute-'+idx:'sub-cut-'+idx;
      var b2lbl=isBass?'M':'E';
      var b2fn =isBass?function(){pads[idx].muted=!pads[idx].muted;updatePadUI(idx);}
                      :function(){pads[idx].cut=!pads[idx].cut;updatePadUI(idx);};
      [
        {id:'sub-del-'+idx, cls:'del-btn',label:'X', fn:function(){clearPad(idx);}},
        {id:b2id,           cls:'',       label:b2lbl,fn:b2fn},
        {id:'sub-ofs1-'+idx,cls:'',       label:'>',  fn:function(){pads[idx].offset=pads[idx].offset===4?0:4;updatePadUI(idx);}},
        {id:'sub-ofs2-'+idx,cls:'',       label:'>>',fn:function(){pads[idx].offset=pads[idx].offset===8?0:8;updatePadUI(idx);}},
      ].forEach(function(b){
        var btn=document.createElement('button');
        btn.className='sub-btn '+b.cls; btn.id=b.id; btn.textContent=b.label;
        btn.disabled=true; btn.addEventListener('click',b.fn);
        sub.appendChild(btn);
      });
      cell.appendChild(tap); cell.appendChild(sub); grid.appendChild(cell);
    })(i);
  }
}

function buildGrooveSelector(){
  var sel=document.getElementById('groove-select');
  GROOVES.forEach(function(g,i){
    var o=document.createElement('option'); o.value=i; o.textContent=g.name; sel.appendChild(o);
  });
}

buildUI();
buildGrooveSelector();
document.addEventListener('click',     function(){getAudioCtx();getMic();},{once:true});
document.addEventListener('touchstart',function(){getAudioCtx();getMic();},{once:true,passive:true});
setStatus('hold a pad to record');
</script>
</body>
</html>
