<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>SMPLJAM</title>
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
:root {
  --bg: #0d0d0d; --panel: #161616; --border: #2a2a2a;
  --accent: #e8ff3a; --red: #ff3a3a; --red-dark: #3a0000;
  --text: #f0f0f0; --sub: #777; --dim: #333;
  --green: #3aff8a; --green-dark: #002210;
  --btn-bg: #ccccc4; --btn-text: #111;
}
body {
  background: var(--bg); color: var(--text);
  font-family: 'Courier New', Courier, monospace;
  min-height: 100vh; display: flex; flex-direction: column;
  align-items: center; padding: 12px 10px 20px;
  user-select: none; -webkit-user-select: none; touch-action: manipulation;
}

/* ── Header ── */
header { text-align: center; margin-bottom: 10px; }
h1 { font-family: Impact, 'Arial Black', sans-serif; font-size: 42px; letter-spacing: 7px; color: var(--accent); line-height: 1; }
.tagline { font-size: 9px; color: var(--sub); letter-spacing: 4px; text-transform: uppercase; margin-top: 2px; }

/* ── Transport ── */
.transport {
  display: flex; align-items: center; gap: 8px;
  background: var(--panel); border: 1px solid var(--border);
  padding: 8px 12px; border-radius: 4px;
  width: 100%; max-width: 540px; margin-bottom: 10px;
  flex-wrap: wrap; justify-content: center;
}
.bpm-group { display: flex; align-items: center; gap: 5px; }
.bpm-label { font-size: 9px; color: var(--sub); letter-spacing: 2px; }
.bpm-display { font-family: Impact, 'Arial Black', sans-serif; font-size: 28px; color: var(--accent); width: 52px; text-align: center; }
.bpm-controls { display: flex; flex-direction: column; gap: 2px; }
.bpm-btn { background: none; border: 1px solid var(--border); color: var(--text); font-size: 9px; padding: 1px 6px; cursor: pointer; transition: all 0.1s; border-radius: 2px; }
.bpm-btn:hover { border-color: var(--accent); color: var(--accent); }
.divider { width: 1px; height: 30px; background: var(--border); flex-shrink: 0; }
#play-btn {
  background: none; border: 2px solid var(--accent); color: var(--accent);
  font-family: Impact, 'Arial Black', sans-serif; font-size: 14px; letter-spacing: 2px;
  padding: 6px 14px; cursor: pointer; transition: all 0.15s; border-radius: 3px;
}
#play-btn.playing { background: var(--accent); color: var(--bg); }
#metro-btn {
  background: none; border: 1px solid var(--accent); color: var(--accent);
  font-size: 9px; letter-spacing: 1px; padding: 4px 8px;
  cursor: pointer; border-radius: 2px; transition: all 0.15s;
}
#metro-btn.muted { border-color: var(--border); color: var(--sub); text-decoration: line-through; }
.beat-dots { display: flex; gap: 5px; align-items: center; }
.beat-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--border); transition: background 0.05s; }
.beat-dot.active { background: var(--accent); }
.groove-sel {
  background: var(--bg); border: 1px solid var(--border); color: var(--text);
  font-family: 'Courier New', Courier, monospace; font-size: 9px; padding: 4px 6px;
  border-radius: 2px; cursor: pointer; max-width: 120px;
}
.groove-sel:focus { outline: none; border-color: var(--accent); }

/* ── Pads grid — all 4 identical ── */
.pads-grid {
  display: grid; grid-template-columns: 1fr 1fr; gap: 8px;
  width: 100%; max-width: 540px;
}
.pad-cell { display: flex; flex-direction: column; gap: 4px; }

/* ── Big tap area ── */
.pad-tap {
  position: relative; border-radius: 4px; overflow: hidden;
  height: 112px; cursor: pointer;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  border: 2px solid var(--border); background: var(--panel);
  transition: border-color 0.15s, background 0.15s;
  -webkit-tap-highlight-color: transparent;
}

/* State colours */
.pad-tap.st-empty { border-color: var(--border);    background: var(--panel); }
.pad-tap.st-beep  { border-color: var(--red-dark);  background: #1a0000; }
.pad-tap.st-rec   { border-color: var(--red);       background: #160000; animation: prec 0.45s infinite alternate; }
.pad-tap.st-proc  { border-color: var(--red-dark);  background: #1a0000; }
.pad-tap.st-play  { border-color: var(--green);     background: var(--green-dark); }

@keyframes prec {
  from { box-shadow: none; }
  to   { box-shadow: 0 0 16px 5px rgba(255,58,58,0.45); }
}

/* Trigger flash */
.pad-tap::before {
  content: ''; position: absolute; inset: 0; background: var(--accent);
  opacity: 0; pointer-events: none; transition: opacity 0.05s;
}
.pad-tap.flash::before      { opacity: 0.2; }
.pad-tap.flash-soft::before { opacity: 0.08; }

/* Canvas behind content */
.pad-tap canvas {
  position: absolute; inset: 0; width: 100%; height: 100%;
  opacity: 0; pointer-events: none;
}
.pad-tap.st-play canvas { opacity: 0.5; }
.pad-tap.st-rec  canvas { opacity: 0.55; }

/* Pad number */
.pad-num {
  position: relative; z-index: 2; pointer-events: none;
  font-family: Impact, 'Arial Black', sans-serif; font-size: 38px; letter-spacing: 2px;
  transition: color 0.15s; color: var(--dim);
}
.pad-tap.st-empty .pad-num { color: var(--dim); }
.pad-tap.st-beep  .pad-num { color: #2a0000; }
.pad-tap.st-rec   .pad-num { color: var(--red); }
.pad-tap.st-proc  .pad-num { color: #2a0000; }
.pad-tap.st-play  .pad-num { color: var(--green); }

/* Small info line */
.pad-info {
  position: relative; z-index: 2; pointer-events: none;
  font-size: 8px; letter-spacing: 1px; margin-top: 4px;
  color: transparent; transition: color 0.15s;
}
.pad-tap.st-play .pad-info { color: var(--green); }
.pad-tap.st-rec  .pad-info { color: var(--red); }

/* ── Sub-buttons — light background, dark text ── */
.pad-sub { display: grid; grid-template-columns: repeat(4, 1fr); gap: 3px; }
.sub-btn {
  font-family: 'Courier New', Courier, monospace; font-size: 11px; font-weight: bold;
  padding: 8px 2px; border-radius: 3px; cursor: pointer; border: none;
  background: var(--btn-bg); color: var(--btn-text);
  text-transform: uppercase; transition: background 0.1s, color 0.1s; text-align: center;
}
.sub-btn:disabled { opacity: 0.25; cursor: default; pointer-events: none; }
/* Active state = bright red */
.sub-btn.is-active { background: var(--red) !important; color: #fff !important; }
/* X always has a warm tint when enabled */
.sub-btn.del-btn:not(:disabled) { background: #e8b0b0; }
.sub-btn.del-btn:not(:disabled):hover { background: var(--red); color: #fff; }

/* ── Status ── */
.status-bar {
  margin-top: 8px; font-size: 9px; color: var(--sub);
  letter-spacing: 1px; text-align: center; min-height: 14px;
  width: 100%; max-width: 540px;
}
</style>
</head>
<body>

<header>
  <h1>SMPLJAM</h1>
  <div class="tagline">groove sampler</div>
</header>

<div class="transport">
  <div class="bpm-group">
    <span class="bpm-label">BPM</span>
    <div class="bpm-display" id="bpm-display">120</div>
    <div class="bpm-controls">
      <button class="bpm-btn" id="bpm-up">&#9650;</button>
      <button class="bpm-btn" id="bpm-down">&#9660;</button>
    </div>
  </div>
  <div class="divider"></div>
  <button id="play-btn">&#9654; PLAY</button>
  <div class="divider"></div>
  <button id="metro-btn">CLICK</button>
  <div class="divider"></div>
  <select class="groove-sel" id="groove-select"></select>
  <div class="divider"></div>
  <div class="beat-dots">
    <div class="beat-dot" id="dot-0"></div>
    <div class="beat-dot" id="dot-1"></div>
    <div class="beat-dot" id="dot-2"></div>
    <div class="beat-dot" id="dot-3"></div>
  </div>
</div>

<div class="pads-grid" id="pads-grid"></div>

<div class="status-bar" id="status-bar">hold a pad to record</div>

<script>
// ─────────────────────────────────────────────────────────
// CONFIG
// ─────────────────────────────────────────────────────────
var PAD_ROWS = ['kick','snare','hihat','kick']; // pad 3 = bass (row unused)
var VELOCITY = [0, 0.42, 1.0];
var bpm = 120, isPlaying = false, currentStep = -1, beatInterval = null;
var audioCtx = null, micStream = null;
var metroMuted = false, metroScheduler = null, metroNextTime = 0, metroBeat = 0, metroGain = null;
var masterGain = null, masterLimiter = null;

var pads = [];
for (var _i = 0; _i < 4; _i++) {
  pads.push({
    index: _i, isBass: _i === 3,
    buffer: null,       // AudioBuffer for 0-2; truthy flag for bass
    bassNotes: null,    // array[16] of {freq,name}|null — bass only
    state: 'empty',     // empty|beep|rec|proc|play
    offset: 0,          // 0, 4, or 8 steps
    cut: false, muted: false,
    pcmChunks: [], scriptRecorder: null, muteGain: null,
    analyser: null, analyserSource: null, liveAnimFrame: null,
    recTimer: null, bassPitchInterval: null, bassRecordedNotes: [],
  });
}

// ─────────────────────────────────────────────────────────
// GROOVES
// ─────────────────────────────────────────────────────────
var GROOVES = [
  {name:"Basic Rock",   kick:[2,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0],snare:[0,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0],hihat:[1,0,1,0,1,0,1,0,1,0,1,0,1,0,1,0]},
  {name:"Funk",         kick:[2,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0],snare:[0,0,0,0,2,0,0,1,0,0,0,0,2,0,1,0],hihat:[2,1,1,1,1,2,1,1,2,1,1,1,1,2,1,1]},
  {name:"Hip-Hop",      kick:[2,0,0,0,0,0,1,0,2,0,0,0,0,1,0,0],snare:[0,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0],hihat:[1,0,1,0,0,1,0,0,1,0,1,0,0,1,0,1]},
  {name:"Trap",         kick:[2,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0],snare:[0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0],hihat:[1,1,2,1,1,1,2,1,1,1,2,1,1,1,2,1]},
  {name:"Four-on-Floor",kick:[2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0],snare:[0,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0],hihat:[1,1,2,1,1,1,2,1,1,1,2,1,1,1,2,1]},
  {name:"Disco",        kick:[2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0],snare:[0,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0],hihat:[1,0,2,0,1,0,2,0,1,0,2,0,1,0,2,0]},
  {name:"Shuffle",      kick:[2,0,1,0,0,1,0,0,2,0,1,0,0,1,0,0],snare:[0,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0],hihat:[1,0,2,0,1,0,2,0,1,0,2,0,1,0,2,0]},
  {name:"Jazz Swing",   kick:[2,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0],snare:[0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0],hihat:[2,0,1,0,2,0,1,0,2,0,1,0,2,0,1,0]},
  {name:"Reggae",       kick:[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],snare:[0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0],hihat:[0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0]},
  {name:"Bossa Nova",   kick:[2,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0],snare:[0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0],hihat:[1,1,0,1,1,0,1,1,0,1,1,0,1,1,0,1]},
  {name:"Breakbeat",    kick:[2,0,0,0,0,0,1,0,0,0,2,0,0,1,0,0],snare:[0,0,0,0,2,0,0,1,0,0,0,0,1,1,0,0],hihat:[2,1,1,1,1,1,1,1,2,1,1,1,1,1,1,1]},
  {name:"Trip-Hop",     kick:[2,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0],snare:[0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0],hihat:[1,0,0,0,1,0,0,0,1,0,0,0,0,0,1,0]},
  {name:"2-Step",       kick:[2,0,0,0,0,1,0,0,2,0,0,1,0,0,0,0],snare:[0,0,0,0,0,0,2,0,0,0,0,0,0,0,2,0],hihat:[1,0,1,1,0,1,0,1,1,0,1,1,0,1,0,1]},
  {name:"Afrobeat",     kick:[2,0,0,1,0,0,1,0,0,0,2,0,0,1,0,0],snare:[0,0,0,0,1,0,0,0,1,0,0,0,0,0,1,0],hihat:[2,0,1,0,1,0,2,0,1,0,1,0,2,0,1,0]},
  {name:"Samba",        kick:[2,0,1,0,0,1,0,1,2,0,1,0,0,1,0,0],snare:[0,1,0,0,2,0,1,0,0,1,0,0,2,0,1,0],hihat:[2,1,1,1,2,1,1,1,2,1,1,1,2,1,1,1]},
];

// ─────────────────────────────────────────────────────────
// AUDIO CONTEXT + MASTER CHAIN
// ─────────────────────────────────────────────────────────
function getAudioCtx() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    masterGain = audioCtx.createGain(); masterGain.gain.value = 1.0;
    masterLimiter = audioCtx.createDynamicsCompressor();
    masterLimiter.threshold.value = -3; masterLimiter.knee.value = 2;
    masterLimiter.ratio.value = 20; masterLimiter.attack.value = 0.001; masterLimiter.release.value = 0.1;
    masterGain.connect(masterLimiter); masterLimiter.connect(audioCtx.destination);
    metroGain = audioCtx.createGain(); metroGain.gain.value = metroMuted ? 0 : 1;
    metroGain.connect(masterGain);
  }
  if (audioCtx.state === 'suspended') audioCtx.resume();
  return audioCtx;
}
function duckMaster(on) {
  if (!masterGain) return;
  masterGain.gain.setTargetAtTime(on ? 0.5 : 1.0, audioCtx.currentTime, 0.04);
}
async function getMic() {
  if (micStream) return micStream;
  try {
    micStream = await navigator.mediaDevices.getUserMedia({
      audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: false }, video: false
    });
    return micStream;
  } catch(e) { setStatus('mic denied'); return null; }
}

// ─────────────────────────────────────────────────────────
// METRONOME
// ─────────────────────────────────────────────────────────
function scheduleClick(time, accent) {
  var ctx = getAudioCtx(), osc = ctx.createOscillator(), env = ctx.createGain();
  osc.connect(env); env.connect(metroGain);
  osc.frequency.value = accent ? 1200 : 900; osc.type = 'sine';
  env.gain.setValueAtTime(0, time); env.gain.linearRampToValueAtTime(0.5, time+0.003); env.gain.exponentialRampToValueAtTime(0.001, time+0.06);
  osc.start(time); osc.stop(time+0.08);
}
function startMetronome() {
  var ctx = getAudioCtx(); metroBeat = 0; metroNextTime = ctx.currentTime + 0.05;
  function sched() { while (metroNextTime < ctx.currentTime+0.2) { scheduleClick(metroNextTime, metroBeat%4===0); metroBeat++; metroNextTime += 60.0/bpm; } }
  metroScheduler = setInterval(sched, 50); sched();
}
function stopMetronome() { if (metroScheduler) { clearInterval(metroScheduler); metroScheduler = null; } }
function restartMetronome() { stopMetronome(); startMetronome(); }

// Soft pre-record beep
function playBeep(cb) {
  var ctx = getAudioCtx(), now = ctx.currentTime;
  var osc = ctx.createOscillator(), env = ctx.createGain();
  osc.connect(env); env.connect(masterGain);
  osc.type = 'sine'; osc.frequency.value = 880;
  env.gain.setValueAtTime(0, now); env.gain.linearRampToValueAtTime(0.18, now+0.01); env.gain.exponentialRampToValueAtTime(0.001, now+0.12);
  osc.start(now); osc.stop(now+0.14);
  setTimeout(cb, 160);
}

document.getElementById('metro-btn').addEventListener('click', function() {
  metroMuted = !metroMuted;
  document.getElementById('metro-btn').classList.toggle('muted', metroMuted);
  if (metroGain) metroGain.gain.setTargetAtTime(metroMuted ? 0 : 1, getAudioCtx().currentTime, 0.02);
});

// ─────────────────────────────────────────────────────────
// LIVE VISUALISER (during recording)
// ─────────────────────────────────────────────────────────
function startLiveViz(pad) {
  var canvas = document.getElementById('wave-'+pad.index); if (!canvas) return;
  var c = canvas.getContext('2d'), analyser = pad.analyser;
  var bufLen = analyser.frequencyBinCount, data = new Uint8Array(bufLen);
  var W = canvas.width, H = canvas.height, hist = new Float32Array(W), hp = 0;
  function draw() {
    if (pad.state !== 'rec') return;
    pad.liveAnimFrame = requestAnimationFrame(draw);
    analyser.getByteTimeDomainData(data);
    var s = 0; for (var k=0;k<bufLen;k++){var v=(data[k]/128.0)-1.0;s+=v*v;}
    hist[hp%W] = Math.sqrt(s/bufLen); hp++;
    c.clearRect(0,0,W,H); var mid = H/2;
    for (var x=0;x<W;x++){
      var rms = hist[(hp-W+x+W*4)%W], amp = Math.min(rms*H*4,mid);
      c.fillStyle = 'rgba(255,58,58,'+(0.4+(x/W)*0.6)+')';
      c.fillRect(x, mid-amp, 1, Math.max(amp*2,1));
    }
  }
  draw();
}
function stopLiveViz(pad) {
  if (pad.liveAnimFrame) { cancelAnimationFrame(pad.liveAnimFrame); pad.liveAnimFrame = null; }
  if (pad.analyserSource) { try { pad.analyserSource.disconnect(); } catch(e){} pad.analyserSource = null; }
  pad.analyser = null;
}

// ─────────────────────────────────────────────────────────
// PCM RECORDING — ScriptProcessor (iOS safe)
// ─────────────────────────────────────────────────────────
function startPCMRecord(pad, stream) {
  var ctx = getAudioCtx();
  var source = ctx.createMediaStreamSource(stream);
  var analyser = ctx.createAnalyser(); analyser.fftSize = 1024;
  source.connect(analyser); pad.analyser = analyser; pad.analyserSource = source;
  var recorder = ctx.createScriptProcessor(4096, 1, 1);
  recorder.onaudioprocess = function(e) {
    if (pad.state === 'rec') pad.pcmChunks.push(new Float32Array(e.inputBuffer.getChannelData(0)));
  };
  var mute = ctx.createGain(); mute.gain.value = 0;
  source.connect(recorder); recorder.connect(mute); mute.connect(ctx.destination);
  pad.scriptRecorder = recorder; pad.muteGain = mute;
}
function stopPCMRecord(pad) {
  if (pad.scriptRecorder) { try { pad.scriptRecorder.disconnect(); } catch(e){} pad.scriptRecorder = null; }
  if (pad.muteGain)       { try { pad.muteGain.disconnect(); }       catch(e){} pad.muteGain = null; }
  stopLiveViz(pad);
}

// ─────────────────────────────────────────────────────────
// TRIM + ASSEMBLE
// ─────────────────────────────────────────────────────────
function trimSilence(buf) {
  var data = buf.getChannelData(0), sr = buf.sampleRate;
  var peak = 0; for (var p=0;p<data.length;p++){var ap=Math.abs(data[p]);if(ap>peak)peak=ap;}
  if (peak < 0.001) return buf;
  var thr = peak*0.05, win = Math.max(Math.floor(sr*0.002),1), start = -1;
  for (var n=0;n<data.length-win;n+=win){
    var ws=0; for(var w=0;w<win;w++) ws+=data[n+w]*data[n+w];
    if (Math.sqrt(ws/win)>thr){start=Math.max(0,n-win);break;}
  }
  if (start<=0) return buf;
  var ctx=getAudioCtx(), nc=buf.numberOfChannels, newLen=buf.length-start; if(newLen<=0)return buf;
  var out=ctx.createBuffer(nc,newLen,sr);
  for(var c=0;c<nc;c++){var src=buf.getChannelData(c),dst=out.getChannelData(c);for(var s=0;s<newLen;s++) dst[s]=src[start+s];}
  return out;
}
function chunksToBuffer(chunks) {
  var total=0; for(var i=0;i<chunks.length;i++) total+=chunks[i].length;
  var combined=new Float32Array(total),off=0;
  for(var j=0;j<chunks.length;j++){combined.set(chunks[j],off);off+=chunks[j].length;}
  var ctx=getAudioCtx(), buf=ctx.createBuffer(1,combined.length,ctx.sampleRate);
  buf.getChannelData(0).set(combined); return buf;
}

// ─────────────────────────────────────────────────────────
// HOLD RECORDING — PADS 0-2  (max = 1 beat = bar/4)
// ─────────────────────────────────────────────────────────
function oneBeatMs() { return (60 / bpm) * 1000; }

function padHoldStart(idx) {
  var pad = pads[idx];
  if (pad.state==='rec'||pad.state==='beep') return;
  getAudioCtx(); if (!metroScheduler) startMetronome();
  pad.state = 'beep'; updatePadUI(idx); duckMaster(true);
  playBeep(function() {
    if (pad.state !== 'beep') return;
    getMic().then(function(stream) {
      if (!stream||pad.state!=='beep'){pad.state=pad.buffer?'play':'empty';updatePadUI(idx);duckMaster(false);return;}
      pad.pcmChunks=[]; pad.state='rec'; updatePadUI(idx);
      startPCMRecord(pad, stream); startLiveViz(pad);
      // Auto-stop after 1 beat
      pad.recTimer = setTimeout(function(){ padHoldEnd(idx); }, oneBeatMs());
    });
  });
}
function padHoldEnd(idx) {
  var pad = pads[idx];
  if (pad.recTimer){clearTimeout(pad.recTimer);pad.recTimer=null;}
  if (pad.state==='beep'){pad.state=pad.buffer?'play':'empty';updatePadUI(idx);duckMaster(false);return;}
  if (pad.state!=='rec') return;
  pad.state='proc'; updatePadUI(idx); stopPCMRecord(pad); duckMaster(false);
  if (pad.pcmChunks.length===0){pad.state=pad.buffer?'play':'empty';updatePadUI(idx);return;}
  var raw=chunksToBuffer(pad.pcmChunks); pad.buffer=trimSilence(raw); pad.pcmChunks=[];
  pad.state='play'; drawWaveform(idx); updatePadUI(idx);
  setStatus((idx+1)+' ready — '+pad.buffer.duration.toFixed(2)+'s');
}

// ─────────────────────────────────────────────────────────
// HOLD RECORDING — PAD 3 / BASS (pitch detection, max 4 bars)
// ─────────────────────────────────────────────────────────
var NOTE_NAMES=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
var ALL_NOTES=[];
(function(){for(var o=1;o<=4;o++)for(var n=0;n<12;n++){var m=(o+1)*12+n;ALL_NOTES.push({midi:m,freq:440*Math.pow(2,(m-69)/12),name:NOTE_NAMES[n]+o});}})();

function detectPitch(buf, sr) {
  var minOff=Math.floor(sr/600), maxOff=Math.floor(sr/70); if(maxOff>=buf.length)maxOff=buf.length-1;
  var rms=0; for(var i=0;i<buf.length;i++) rms+=buf[i]*buf[i]; rms=Math.sqrt(rms/buf.length);
  if(rms<0.002) return null;
  var WIN=Math.min(1024,Math.floor(buf.length/2)),bestOff=-1,bestCorr=-1;
  for(var off=minOff;off<=maxOff;off++){var c=0;for(var j=0;j<WIN;j++) c+=buf[j]*buf[j+off];if(c>bestCorr){bestCorr=c;bestOff=off;}}
  if(bestOff===-1||bestCorr<0.002) return null;
  return sr/bestOff;
}
function freqToNote(freq) {
  if(!freq||freq<40||freq>2000) return null;
  var midi=12*Math.log2(freq/440)+69,best=null,bd=999;
  ALL_NOTES.forEach(function(n){var d=Math.abs(n.midi-midi);if(d<bd){bd=d;best=n;}});
  return bd<2.5?best:null;
}
function playBassNote(freq, dur, vel) {
  if(!freq||freq<20) return;
  var ctx=getAudioCtx(),now=ctx.currentTime;
  var o1=ctx.createOscillator(),o2=ctx.createOscillator(),filt=ctx.createBiquadFilter(),gain=ctx.createGain();
  o1.type='sawtooth';o1.frequency.value=freq; o2.type='sine';o2.frequency.value=freq;
  filt.type='lowpass'; filt.frequency.setValueAtTime(300,now); filt.frequency.linearRampToValueAtTime(1400,now+0.03); filt.frequency.exponentialRampToValueAtTime(450,now+dur*0.6); filt.Q.value=2;
  gain.gain.setValueAtTime(0,now); gain.gain.linearRampToValueAtTime(vel*0.65,now+0.02); gain.gain.setValueAtTime(vel*0.65,now+dur*0.55); gain.gain.exponentialRampToValueAtTime(0.001,now+dur*0.92);
  o1.connect(filt);o2.connect(filt);filt.connect(gain);gain.connect(masterGain);
  o1.start(now);o1.stop(now+dur); o2.start(now);o2.stop(now+dur);
}

function fourBarsMs() { return oneBeatMs() * 16; }

function bassHoldStart() {
  var pad = pads[3];
  if (pad.state==='rec'||pad.state==='beep') return;
  getAudioCtx(); if (!metroScheduler) startMetronome();
  pad.state='beep'; updatePadUI(3); duckMaster(true);
  playBeep(function() {
    if (pad.state!=='beep') return;
    getMic().then(function(stream) {
      if(!stream||pad.state!=='beep'){pad.state=pad.bassNotes?'play':'empty';updatePadUI(3);duckMaster(false);return;}
      pad.bassRecordedNotes=[]; pad.state='rec'; updatePadUI(3);
      var ctx=getAudioCtx(), source=ctx.createMediaStreamSource(stream);
      var analyser=ctx.createAnalyser(); analyser.fftSize=2048;
      source.connect(analyser); pad.analyser=analyser; pad.analyserSource=source;
      var buf=new Float32Array(analyser.fftSize),lastNote=null,steadyCount=0;
      pad.bassPitchInterval=setInterval(function(){
        if(pad.state!=='rec') return;
        analyser.getFloatTimeDomainData(buf);
        var freq=detectPitch(buf,ctx.sampleRate), note=freq?freqToNote(freq):null;
        if(note) setStatus('hearing: '+note.name);
        if(note&&lastNote&&note.midi===lastNote.midi){
          steadyCount++;
          if(steadyCount===3){var last=pad.bassRecordedNotes[pad.bassRecordedNotes.length-1];if(!last||last.midi!==note.midi){pad.bassRecordedNotes.push(note);setStatus('notes: '+pad.bassRecordedNotes.map(function(n){return n.name;}).join(' '));}}
        } else { steadyCount=0; }
        lastNote=note;
      },80);
      pad.recTimer=setTimeout(function(){bassHoldEnd();}, fourBarsMs());
    });
  });
}
function bassHoldEnd() {
  var pad=pads[3];
  if(pad.recTimer){clearTimeout(pad.recTimer);pad.recTimer=null;}
  if(pad.state==='beep'){pad.state=pad.bassNotes?'play':'empty';updatePadUI(3);duckMaster(false);return;}
  if(pad.state!=='rec') return;
  clearInterval(pad.bassPitchInterval);pad.bassPitchInterval=null;
  if(pad.analyserSource){try{pad.analyserSource.disconnect();}catch(e){} pad.analyserSource=null;} pad.analyser=null;
  duckMaster(false);
  if(pad.bassRecordedNotes.length===0){pad.state=pad.bassNotes?'play':'empty';setStatus('no notes heard');updatePadUI(3);return;}
  var notes=new Array(16).fill(null),toPlace=pad.bassRecordedNotes.slice(0,16),spacing=Math.max(Math.floor(16/toPlace.length),1);
  toPlace.forEach(function(n,i){notes[Math.min(i*spacing,15)]=n;});
  pad.bassNotes=notes; pad.buffer=true; pad.state='play'; updatePadUI(3);
  setStatus(toPlace.length+' bass notes placed');
}

// ─────────────────────────────────────────────────────────
// SAMPLE PLAYBACK
// ─────────────────────────────────────────────────────────
function triggerPad(idx, vel) {
  var pad=pads[idx]; if(!pad.buffer||vel<=0||pad.muted||pad.isBass) return;
  var ctx=getAudioCtx(), src=ctx.createBufferSource(); src.buffer=pad.buffer;
  var gain=ctx.createGain(); gain.gain.value=Math.min(vel,1.0);
  src.connect(gain); gain.connect(masterGain);
  if(pad.cut){
    var half=pad.buffer.duration*0.5,fadeAt=half*0.8;
    gain.gain.setValueAtTime(vel,ctx.currentTime+fadeAt); gain.gain.linearRampToValueAtTime(0.0001,ctx.currentTime+half);
    src.start(); src.stop(ctx.currentTime+half);
  } else { src.start(); }
  var tapEl=document.getElementById('pad-tap-'+idx);
  tapEl.classList.add(vel>0.7?'flash':'flash-soft');
  setTimeout(function(){tapEl.classList.remove('flash','flash-soft');},vel>0.7?100:60);
}
function clearPad(idx) {
  var pad=pads[idx]; if(pad.recTimer){clearTimeout(pad.recTimer);pad.recTimer=null;}
  pad.buffer=null; pad.bassNotes=null; pad.state='empty'; pad.offset=0; pad.cut=false; pad.muted=false;
  clearWaveform(idx); updatePadUI(idx);
}

// ─────────────────────────────────────────────────────────
// SEQUENCER
// ─────────────────────────────────────────────────────────
function stepMs() { return (60/bpm/4)*1000; }
function startSequencer(){currentStep=-1;beatInterval=setInterval(tick,stepMs());tick();}
function stopSequencer(){
  clearInterval(beatInterval);beatInterval=null;currentStep=-1;
  document.querySelectorAll('.beat-dot').forEach(function(d){d.classList.remove('active');});
}
function tick() {
  currentStep=(currentStep+1)%16;
  if(currentStep%4===0){var qb=currentStep/4;document.querySelectorAll('.beat-dot').forEach(function(d,i){d.classList.toggle('active',i===qb);});}
  var gi=parseInt(document.getElementById('groove-select').value)||0, groove=GROOVES[gi];
  // Pads 0-2
  for(var pi=0;pi<3;pi++){
    var pad=pads[pi]; if(pad.state!=='play'||!pad.buffer||pad.muted) continue;
    var step=(currentStep-pad.offset+16)%16, vel=VELOCITY[groove[PAD_ROWS[pi]][step]]||0;
    if(vel>0) triggerPad(pi,vel);
  }
  // Bass: fire all notes from downbeat using setTimeout, once per loop
  if(currentStep===0){
    var bp=pads[3]; if(bp.state==='play'&&bp.bassNotes&&!bp.muted){
      var sdur=stepMs()/1000;
      bp.bassNotes.forEach(function(note,si){
        if(!note) return;
        var delay=((si-bp.offset+16)%16)*stepMs();
        setTimeout(function(){if(bp.state==='play'&&!bp.muted) playBassNote(note.freq,sdur*0.85,0.8);},delay);
      });
    }
  }
}

// ─────────────────────────────────────────────────────────
// TRANSPORT
// ─────────────────────────────────────────────────────────
document.getElementById('play-btn').addEventListener('click',function(){
  getAudioCtx(); if(!metroScheduler) startMetronome();
  isPlaying=!isPlaying;
  var btn=document.getElementById('play-btn');
  if(isPlaying){btn.innerHTML='&#9632; STOP';btn.classList.add('playing');startSequencer();}
  else{btn.innerHTML='&#9654; PLAY';btn.classList.remove('playing');stopSequencer();setStatus('stopped');}
});
document.getElementById('bpm-up').addEventListener('click',  function(){changeBpm(5);});
document.getElementById('bpm-down').addEventListener('click',function(){changeBpm(-5);});
function changeBpm(d){
  bpm=Math.max(40,Math.min(240,bpm+d));
  document.getElementById('bpm-display').textContent=bpm;
  if(isPlaying){stopSequencer();startSequencer();}
  if(metroScheduler) restartMetronome();
}

// ─────────────────────────────────────────────────────────
// WAVEFORM
// ─────────────────────────────────────────────────────────
function drawWaveform(idx) {
  var pad=pads[idx]; if(!pad.buffer||pad.isBass) return;
  var canvas=document.getElementById('wave-'+idx), c=canvas.getContext('2d');
  var data=pad.buffer.getChannelData(0), W=canvas.width, H=canvas.height;
  c.clearRect(0,0,W,H); c.strokeStyle='#3aff8a'; c.lineWidth=1.5; c.beginPath();
  var step=Math.ceil(data.length/W);
  for(var x=0;x<W;x++){
    var mn=1,mx=-1; for(var j=0;j<step;j++){var s=data[x*step+j]||0;if(s<mn)mn=s;if(s>mx)mx=s;}
    var y1=(1-(mx+1)/2)*H,y2=(1-(mn+1)/2)*H;
    if(x===0)c.moveTo(x,y1);else c.lineTo(x,y1); c.lineTo(x,y2);
  }
  c.stroke();
}
function clearWaveform(idx){var cv=document.getElementById('wave-'+idx);cv.getContext('2d').clearRect(0,0,cv.width,cv.height);}

// ─────────────────────────────────────────────────────────
// PAD UI
// ─────────────────────────────────────────────────────────
function updatePadUI(idx) {
  var pad=pads[idx];
  var tapEl=document.getElementById('pad-tap-'+idx);
  var infoEl=document.getElementById('pad-info-'+idx);
  var delBtn=document.getElementById('sub-del-'+idx);
  var cutBtn=document.getElementById('sub-cut-'+idx);
  var ofs1Btn=document.getElementById('sub-ofs1-'+idx);
  var ofs2Btn=document.getElementById('sub-ofs2-'+idx);
  var muteBtn=document.getElementById('sub-mute-'+idx);

  tapEl.className='pad-tap st-'+pad.state;

  if(pad.state==='play'){
    if(pad.isBass&&pad.bassNotes){var nms=pad.bassNotes.filter(Boolean).map(function(n){return n.name;});infoEl.textContent=nms.slice(0,4).join(' ');}
    else if(pad.buffer&&pad.buffer.duration) infoEl.textContent=pad.buffer.duration.toFixed(2)+'s';
    else infoEl.textContent='';
  } else if(pad.state==='rec'){
    infoEl.textContent=pad.isBass?'sing…':'rec…';
  } else { infoEl.textContent=''; }

  var has=!!(pad.buffer||pad.bassNotes);
  if(delBtn)  delBtn.disabled=!has;
  if(cutBtn)  {cutBtn.disabled=!has;cutBtn.classList.toggle('is-active',pad.cut);}
  if(ofs1Btn) {ofs1Btn.disabled=!has;ofs1Btn.classList.toggle('is-active',pad.offset===4);}
  if(ofs2Btn) {ofs2Btn.disabled=!has;ofs2Btn.classList.toggle('is-active',pad.offset===8);}
  if(muteBtn) {muteBtn.disabled=!has;muteBtn.classList.toggle('is-active',pad.muted);}
}
function setStatus(msg){document.getElementById('status-bar').textContent=msg;}

// ─────────────────────────────────────────────────────────
// BUILD UI — all 4 pads identical
// ─────────────────────────────────────────────────────────
function buildUI() {
  var grid=document.getElementById('pads-grid');
  for(var i=0;i<4;i++){
    (function(idx){
      var isBass=idx===3;
      var cell=document.createElement('div'); cell.className='pad-cell';

      // Tap area
      var tap=document.createElement('div'); tap.className='pad-tap st-empty'; tap.id='pad-tap-'+idx;
      var canvas=document.createElement('canvas'); canvas.id='wave-'+idx; canvas.width=300; canvas.height=112;
      var numEl=document.createElement('div'); numEl.className='pad-num'; numEl.id='pad-num-'+idx; numEl.textContent=idx+1;
      var infoEl=document.createElement('div'); infoEl.className='pad-info'; infoEl.id='pad-info-'+idx;
      tap.appendChild(canvas); tap.appendChild(numEl); tap.appendChild(infoEl);

      function onDown(e){e.preventDefault(); isBass?bassHoldStart():padHoldStart(idx);}
      function onUp(e)  {e.preventDefault(); isBass?bassHoldEnd()  :padHoldEnd(idx);}
      tap.addEventListener('mousedown',  onDown);
      tap.addEventListener('mouseup',    onUp);
      tap.addEventListener('mouseleave', onUp);
      tap.addEventListener('touchstart', onDown,{passive:false});
      tap.addEventListener('touchend',   onUp,  {passive:false});
      tap.addEventListener('touchcancel',onUp,  {passive:false});

      // Sub-buttons — same 4 for all pads; bass has M instead of E
      var sub=document.createElement('div'); sub.className='pad-sub';
      var btnDefs=[
        {id:'sub-del-'+idx,  cls:'del-btn', label:'X',  fn:function(){clearPad(idx);}},
        {id:'sub-cut-'+idx,  cls:'',        label: isBass?'M':'E',
          fn: isBass
            ? function(){pads[idx].muted=!pads[idx].muted;updatePadUI(idx);}
            : function(){pads[idx].cut=!pads[idx].cut;updatePadUI(idx);} },
        {id:'sub-ofs1-'+idx, cls:'',        label:'>',  fn:function(){pads[idx].offset=pads[idx].offset===4?0:4;updatePadUI(idx);}},
        {id:'sub-ofs2-'+idx, cls:'',        label:'>>',fn:function(){pads[idx].offset=pads[idx].offset===8?0:8;updatePadUI(idx);}},
      ];
      // Rebind muteBtn id for bass
      if(isBass) btnDefs[1].id='sub-mute-'+idx;

      btnDefs.forEach(function(b){
        var btn=document.createElement('button');
        btn.className='sub-btn '+b.cls; btn.id=b.id; btn.textContent=b.label;
        btn.disabled=true; btn.addEventListener('click',b.fn);
        sub.appendChild(btn);
      });

      cell.appendChild(tap); cell.appendChild(sub); grid.appendChild(cell);
    })(i);
  }
}

// ─────────────────────────────────────────────────────────
// GROOVE SELECTOR
// ─────────────────────────────────────────────────────────
function buildGrooveSelector(){
  var sel=document.getElementById('groove-select');
  GROOVES.forEach(function(g,i){var o=document.createElement('option');o.value=i;o.textContent=g.name;sel.appendChild(o);});
}

// ─────────────────────────────────────────────────────────
// INIT
// ─────────────────────────────────────────────────────────
buildUI();
buildGrooveSelector();
document.addEventListener('click',     function(){getAudioCtx();getMic();},{once:true});
document.addEventListener('touchstart',function(){getAudioCtx();getMic();},{once:true,passive:true});
setStatus('hold a pad to record  |  M = mute click');
</script>
</body>
</html>
